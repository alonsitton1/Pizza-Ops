<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pizza Ops">
    <meta name="theme-color" content="#d32f2f">
    
    <title>Pizza Ops v21.0</title>
    
    <link rel="shortcut icon" href="https://em-content.zobj.net/source/apple/391/pizza_1f355.png?v=21.0">
    <link rel="icon" type="image/png" href="https://em-content.zobj.net/source/apple/391/pizza_1f355.png?v=21.0">
    <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/391/pizza_1f355.png?v=21.0">

    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #d32f2f; --accent: #1565c0; --bg: #f4f6f8; --card: #ffffff; --text: #37474f; --error: #d32f2f; }
        body { font-family: 'Heebo', sans-serif; background-color: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); margin-bottom: 20px; width: 100%; max-width: 500px; }
        h1 { margin-top: 0; text-align: center; color: var(--primary); font-size: 2rem; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; margin-bottom: 15px; }
        
        /* DATE SECTION FIX */
        .date-section { background: #e3f2fd; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #bbdefb; }
        .date-label { font-weight: 700; color: #1565c0; margin-bottom: 8px; display: block; text-align:center; }
        
        /* IPHONE INPUT FIX */
        input[type="datetime-local"] { 
            width: 100%; 
            max-width: 100%; /* Prevent overflow */
            padding: 12px; 
            border: 1px solid #90caf9; 
            border-radius: 8px; 
            font-size: 1.1rem; 
            background: #fff; 
            color: #1565c0; 
            text-align: center; 
            font-weight: 700; 
            font-family: 'Heebo', sans-serif; 
            direction: ltr; 
            display: block; 
            margin: 0 auto; /* Center block */
            box-sizing: border-box; /* Crucial for iOS */
            -webkit-appearance: none; /* Remove iOS styling */
        }

        /* ERROR BOX */
        .error-box { display: none; background: #ffebee; color: #c62828; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ef9a9a; text-align: center; font-weight: 600; line-height: 1.4; }

        /* STYLE TABS */
        .style-tabs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; background: #eceff1; padding: 5px; border-radius: 10px; }
        .style-tab { text-align: center; padding: 10px 5px; cursor: pointer; border-radius: 8px; font-size: 0.95rem; font-weight: 500; color: #78909c; transition: 0.2s; }
        .style-tab.active { background: #fff; color: var(--text); font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .style-icon { display: block; font-size: 1.3rem; margin-bottom: 2px; }

        /* METHOD SELECTOR */
        .method-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .method-opt { border: 1px solid #cfd8dc; padding: 10px 5px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 500; color: #78909c; transition: all 0.2s; font-size: 0.9rem; background: #fff; }
        .method-opt.active { background-color: var(--primary); color: white; border-color: var(--primary); font-weight: 700; box-shadow: 0 3px 8px rgba(211, 47, 47, 0.2); transform: translateY(-1px); }
        
        /* INPUTS & DROPDOWNS */
        input, select { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 1rem; margin-top: 5px; background-color: #fff; font-family: 'Heebo', sans-serif; color: #333; max-width: 100%; box-sizing: border-box; }
        
        select { 
            -webkit-appearance: none; appearance: none; 
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); 
            background-repeat: no-repeat; 
            background-position: left 15px top 50%; 
            background-size: 10px auto; 
            padding-left: 45px; 
            text-align: right; 
        }
        
        label { margin-top: 15px; display: block; font-weight: 600; font-size: 0.9rem; color: #546e7a; }
        .weather-btn { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 8px; padding: 10px; width: 100%; margin-top: 5px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* SCHEDULE ITEMS */
        .checklist-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 18px 8px; 
            border-bottom: 1px solid #eceff1; 
            cursor: pointer; user-select: none; 
        }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item.checked .step-txt { text-decoration: line-through; color: #81c784; }
        .step-txt { flex-grow: 1; padding-right: 15px; font-size: 1rem; font-weight: 500; } 
        .meta-group { display: flex; align-items: center; flex-shrink: 0; white-space: nowrap; direction: ltr; }
        .check-icon { width: 24px; text-align: center; margin-left: 10px; font-size: 1.2rem; flex-shrink: 0; }
        
        /* DAY BADGE */
        .day-badge { 
            font-weight: 700; color: #546e7a; background: #f5f5f5; 
            padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; 
            margin-right: 10px; white-space: nowrap; display: inline-block; 
            border: 1px solid #e0e0e0;
        }
        .day-badge.today { color: #2e7d32; background: #e8f5e9; border-color: #c8e6c9; }
        .day-badge.tomorrow { color: #e65100; background: #fff3e0; border-color: #ffe0b2; }
        
        .time-gap { 
            display: block; width: fit-content; margin: -10px auto 5px auto;
            text-align: center; font-size: 0.7rem; color: #90a4ae; 
            background: #fff; padding: 2px 8px; border-radius: 10px; 
            position: relative; z-index: 0; border: 1px solid #f0f0f0;
        }

        .row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .row-label { font-weight: 500; font-size: 1rem; color: #455a64; }
        .row-value { font-weight: 700; font-family: 'Heebo', monospace; font-size: 1.1em; color: #263238; }
        .hidden-adv { display: none; margin-top: 15px; padding-top:15px; border-top:1px dashed #cfd8dc; }
        
        .menu-grid { display: grid; gap: 10px; margin-top: 15px; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #eee; padding: 12px 15px; border-radius: 10px; }
        .menu-name { font-weight: 600; font-size: 1rem; color: #333; }
        .qty-btn { width: 32px; height: 32px; background: #eceff1; border-radius: 50%; border: none; font-weight: bold; font-size: 1.2rem; cursor: pointer; color: #546e7a; }
        .qty-val { font-weight: 700; width: 20px; text-align: center; font-size: 1.1rem; margin: 0 10px; }
        .btn-main { border:none; padding:12px; border-radius:8px; font-size:1rem; font-weight:700; cursor:pointer; color:white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 100%; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .action-grid { margin-top:25px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .reset-link { display:block; text-align:center; margin-top:30px; color:#ef5350; cursor:pointer; font-size:0.9rem; font-weight:500; padding-bottom: 30px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ• Pizza Ops</h1>

    <div class="date-section">
        <label class="date-label">ğŸ• ××ª×™ ××•×›×œ×™×?</label>
        <input type="datetime-local" id="targetTime" onchange="calc()">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:15px;">
            <div>
                <label style="margin-top:0">â³ ×ª×”×œ×™×š:</label>
                <select id="scheduleMode" onchange="calc()">
                    <option value="1day" id="opt_sched_1">ğŸš€ ×§×¦×¨ (×”×™×•×)</option>
                    <option value="2day" id="opt_sched_2">ğŸŒ™ ×‘×™× ×•× ×™ (24 ×©×¢×•×ª)</option>
                    <option value="3day" id="opt_sched_3" selected>â„ï¸ ××¨×•×š (48 ×©×¢×•×ª)</option>
                </select>
            </div>
            <div>
                <label style="margin-top:0">ğŸ’¼ ×–××™× ×•×ª:</label>
                <select id="workMode" onchange="calc()">
                    <option value="flexible">ğŸ  ×’××™×©</option>
                    <option value="work" selected>ğŸ’¼ ×¢×‘×•×“×” (17:00+)</option>
                </select>
            </div>
        </div>
    </div>

    <div id="errorBox" class="error-box"></div>

    <div class="style-tabs">
        <div class="style-tab active" id="tab-napoli" onclick="switchStyle('napoli')">
            <span class="style-icon">ğŸ‡®ğŸ‡¹</span>× ××¤×•×œ×™×˜× ×™×ª
        </div>
        <div class="style-tab" id="tab-romana" onclick="switchStyle('romana')">
            <span class="style-icon">ğŸ›ï¸</span>×¨×•×××™×ª
        </div>
        <div class="style-tab" id="tab-ny" onclick="switchStyle('ny')">
            <span class="style-icon">ğŸ—½</span>× ×™×•-×™×•×¨×§
        </div>
    </div>

    <div id="napoliFlourSelect" style="display:block; margin-bottom:15px;">
        <label style="margin-top:0;">ğŸŒ¾ ×‘×—×™×¨×ª ×§××—:</label>
        <select id="flourMix" onchange="saveData()">
            <option value="red_nuvola">××™×§×¡ 50/50 (××•××œ×¥)</option>
            <option value="nuvola">100% × ×•×‘×•×œ×” (××•×•×¨×™×¨×™)</option>
            <option value="red">100% ×§××¤×•×˜×• ××“×•× (×§×œ××¡×™)</option>
            <option value="red_shtibel">××™×§×¡ ×©×˜×™×‘×œ (×‘×™×ª×™)</option>
        </select>
    </div>

    <div class="method-selector" id="methodSelectorContainer">
        <div class="method-opt" onclick="setMethod('direct')" id="btn-direct">×™×©×™×¨</div>
        <div class="method-opt" onclick="setMethod('poolish')" id="btn-poolish">×¤×•×œ×™×©</div>
        <div class="method-opt active" onclick="setMethod('biga')" id="btn-biga">Biga 100%</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>×›××•×ª ×›×“×•×¨×™×</label><input type="number" id="balls" value="6" oninput="calc()"></div>
        <div><label>××©×§×œ ×›×“×•×¨ (×’')</label><input type="number" id="weight" value="250" oninput="calc()"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>×”×™×“×¨×¦×™×” (%)</label><input type="number" id="hydration" value="67" oninput="calc()"></div>
        <div>
            <label>ğŸŒ¡ï¸ ×˜××¤' ×—×“×¨</label>
            <input type="number" id="roomTemp" class="temp-select" value="20" oninput="calc()">
            <div class="weather-btn" onclick="getWeather()">ğŸ“¡ ×¢×“×›×Ÿ</div>
        </div>
    </div>

    <div id="scheduleContainer">
        <div id="scheduleArea" style="margin-top:25px; background:#f1f8e9; padding:10px; border-radius:12px;"></div>
        <div id="recipeArea" style="margin-top:15px; background:#fafafa; padding:15px; border-radius:12px; border:1px solid #eee;"></div>
    </div>

    <div style="text-align:center; margin-top:25px; font-size:0.85rem; color:#90a4ae; cursor:pointer; text-decoration:underline;" onclick="toggleAdv()">×”×’×“×¨×•×ª ××ª×§×“××•×ª</div>
    <div id="adv" class="hidden-adv">
        <label>ğŸ§ª ×¡×•×’ ×©××¨×™×:</label>
        <select id="yeastType" onchange="calc()">
            <option value="dry">×™×‘×©×™× (××™× ×¡×˜× ×˜)</option>
            <option value="fresh">×˜×¨×™×™× (×§×•×‘×™×”/×¤×™×¨×•×¨×™×)</option>
        </select>
        <label>××œ×— (%)</label><input type="number" id="saltPct" value="2.5" step="0.1" oninput="calc()">
        <label>×©××Ÿ (%)</label><input type="number" id="oilPct" value="0" step="0.5" oninput="calc()">
        <label>×¡×•×›×¨ (%)</label><input type="number" id="sugarPct" value="0" step="0.5" oninput="calc()">
        <label>×©××¨×™× ×‘×¡×™×¡ (×™×‘×©×™× %)</label><input type="number" id="yeastPct" value="0.25" step="0.05" oninput="calc()">
        <label>×œ×ª×ª/Malt (%)</label><input type="number" id="maltPct" value="1.0" step="0.1" oninput="calc()">
    </div>
</div>

<div class="container">
    <h2>ğŸ›’ ×ª×¤×¨×™×˜ ×•×§× ×™×•×ª</h2>
    <div id="menuList" class="menu-grid"></div>
    <button onclick="openAddPizzaModal()" class="btn-main" style="width:100%; margin-top:15px; background:#78909c;">+ ×”×•×¡×£ ×¤×™×¦×” ××©×œ×š</button>
    <div class="action-grid">
        <button onclick="generateShopping()" class="btn-main" style="background:var(--accent);">ğŸ›’ ×”×¦×’ ×¨×©×™××”</button>
        <button onclick="shareWhatsApp()" class="btn-main" style="background:#25D366;">ğŸ’¬ ×©×œ×— ×‘×•×•××˜×¡××¤</button>
    </div>
    <div id="shoppingResult" style="display:none; margin-top:20px;">
        <div class="shopping-list"><h3 style="margin:0 0 10px 0; color:#37474f;">ğŸ“‹ ××¦×¨×›×™×</h3><div id="shopList"></div></div>
    </div>
    <div onclick="resetApp()" class="reset-link">ğŸ”„ ××™×¤×•×¡ × ×ª×•× ×™× ×•××—×™×§×ª ×”×›×œ</div>
</div>

<div class="modal-overlay" id="addPizzaModal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ• ×”×•×¡×¤×ª ×¤×™×¦×”</h3>
        <label>×©× ×”×¤×™×¦×”:</label>
        <input type="text" id="newPizzaName" placeholder="×œ××©×œ: ×¤×˜×¨×™×•×ª ×•×©×× ×ª">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="closeAddPizzaModal()" class="btn-main" style="background:#90a4ae; flex:1;">×‘×™×˜×•×œ</button>
            <button onclick="saveNewPizza()" class="btn-main" style="background:var(--primary); flex:1;">×©××•×¨</button>
        </div>
    </div>
</div>

<script>
    let currentStyle = 'napoli';
    let currentMethod = 'biga';
    let menuCounts = {};
    let customPizzas = [];
    let checkedSteps = {}; 

    function init() {
        loadData(); 
        initMenu();
        if(!document.getElementById('targetTime').value) {
            const d = new Date();
            d.setDate(d.getDate() + 1);
            d.setHours(20, 0, 0, 0);
            const pad = n => n<10 ? '0'+n : n;
            document.getElementById('targetTime').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
        calc();
    }

    function toggleAdv() {
        const el = document.getElementById('adv');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function switchStyle(style) {
        currentStyle = style;
        document.querySelectorAll('.style-tab').forEach(e => e.classList.remove('active'));
        document.getElementById(`tab-${style}`).classList.add('active');

        const methodContainer = document.getElementById('methodSelectorContainer');
        const napoliFlour = document.getElementById('napoliFlourSelect');

        methodContainer.style.display = 'none';
        napoliFlour.style.display = 'none';

        if(style === 'napoli') {
            methodContainer.style.display = 'grid';
            napoliFlour.style.display = 'block';
            setMethod('biga');
            document.getElementById('balls').value = 6;
            document.getElementById('weight').value = 250;
            document.getElementById('hydration').value = 67;
            document.getElementById('saltPct').value = 2.5;
            document.getElementById('oilPct').value = 0;
            document.getElementById('sugarPct').value = 0;
            document.getElementById('yeastPct').value = 0.25;
        } else if(style === 'romana') {
            setMethod('direct');
            document.getElementById('balls').value = 4;
            document.getElementById('weight').value = 180;
            document.getElementById('hydration').value = 70;
            document.getElementById('saltPct').value = 3.5;
            document.getElementById('oilPct').value = 5.0; 
            document.getElementById('sugarPct').value = 0;
            document.getElementById('yeastPct').value = 0.25;
        } else if(style === 'ny') {
            setMethod('direct');
            document.getElementById('balls').value = 4;
            document.getElementById('weight').value = 300; 
            document.getElementById('hydration').value = 65;
            document.getElementById('saltPct').value = 2.5;
            document.getElementById('oilPct').value = 2.0;
            document.getElementById('sugarPct').value = 2.0;
            document.getElementById('yeastPct').value = 0.25;
        }
        calc();
    }

    function setMethod(m) {
        currentMethod = m;
        document.querySelectorAll('.method-opt').forEach(e => e.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
        calc();
    }

    function round5(n) { return Math.round(n / 5) * 5; }
    function roundHalf(n) { return Math.round(n * 2) / 2; }

    function calc() {
        const flourName = document.getElementById('flourMix').options[document.getElementById('flourMix').selectedIndex].text;
        const yeastType = document.getElementById('yeastType').value;
        const schedMode = document.getElementById('scheduleMode').value;
        const workMode = document.getElementById('workMode').value;
        const targetDate = new Date(document.getElementById('targetTime').value);
        
        // Hide Error Box initially
        const errorBox = document.getElementById('errorBox');
        const mainContent = document.getElementById('scheduleContainer');
        errorBox.style.display = 'none';
        mainContent.style.display = 'block';

        const p = {
            balls: +document.getElementById('balls').value,
            weight: +document.getElementById('weight').value,
            hyd: +document.getElementById('hydration').value,
            salt: +document.getElementById('saltPct').value,
            oil: +document.getElementById('oilPct').value,
            sugar: +document.getElementById('sugarPct').value,
            yeast: +document.getElementById('yeastPct').value,
            malt: +document.getElementById('maltPct').value
        };

        // Ingredients
        let calcYeastPct = p.yeast;
        if (schedMode === '1day' && currentMethod === 'direct') calcYeastPct = 0.5; 
        if (yeastType === 'fresh') calcYeastPct *= 3;

        const totalWeight = p.balls * p.weight;
        const totalPct = 100 + p.hyd + p.salt + p.oil + p.sugar + calcYeastPct + p.malt;
        const totalFlour = round5((totalWeight / totalPct) * 100);
        const water = round5(totalFlour * (p.hyd/100));
        const salt = roundHalf(totalFlour * (p.salt/100));
        const oil = roundHalf(totalFlour * (p.oil/100));
        const sugar = roundHalf(totalFlour * (p.sugar/100));
        const yeast = roundHalf(totalFlour * (calcYeastPct/100)); 
        const malt = roundHalf(totalFlour * (p.malt/100));

        // --- SCHEDULE LOGIC ---
        let steps = [];
        const subH = (d,h) => new Date(d.getTime() - (h*3600000));
        steps.push({t: targetDate, txt: "ğŸ”¥ ×–××Ÿ ××¤×™×™×”", id: "bake"});

        const applyWork = (d) => {
            if (workMode === 'work' && d.getHours() < 17 && d.getHours() > 6) d.setHours(17, 0);
            return d;
        };

        const ensureBigaHours = (mixDate) => {
            let pref = subH(mixDate, 18);
            if (pref.getHours() >= 1 && pref.getHours() < 6) {
                let newPref = new Date(pref);
                newPref.setHours(23, 0);
                if (newPref >= pref) newPref.setDate(newPref.getDate() - 1);
                let diff = pref - newPref;
                mixDate = new Date(mixDate - diff);
            }
            return mixDate;
        };

        let mixTime, ballTime, bigaTime;

        if (currentStyle === 'napoli') {
            if (schedMode === '3day') { // 48h
                mixTime = subH(targetDate, 48); // Classic 48h
                
                // IF BIGA + 48H: It means 3 days total (Day 1 Biga, Day 2 Mix, Day 3 Bake)
                // So Mix is actually ~24h before bake.
                if (currentMethod !== 'direct') {
                    mixTime = subH(targetDate, 24); 
                    mixTime = ensureBigaHours(mixTime);
                    mixTime = applyWork(mixTime);
                    mixTime = ensureBigaHours(mixTime);
                    bigaTime = subH(mixTime, 18);
                    steps.push({t: bigaTime, txt: "ğŸ¥£ ×”×›× ×ª ×‘×™×’×”", id: "pref"});
                } else {
                    mixTime = applyWork(mixTime);
                }
                
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×”×›× ×ª ×‘×¦×§ ×¢×™×§×¨×™", id: "mix"});
                // Direct: Ball 24h. Biga: Ball 1h after mix.
                if (currentMethod === 'direct') steps.push({t: subH(targetDate, 24), txt: "ğŸ”´ ×›×“×¨×•×¨ (×œ××§×¨×¨)", id: "ball"});
                else steps.push({t: new Date(mixTime.getTime() + 3600000), txt: "ğŸ”´ ×›×“×¨×•×¨ (×œ××§×¨×¨)", id: "ball"});
                
                steps.push({t: subH(targetDate, 1.5), txt: "ğŸŒ¡ï¸ ×”×•×¦××” ××”××§×¨×¨", id: "pull"});

            } else if (schedMode === '2day') { // 24h
                mixTime = subH(targetDate, 24);
                if (currentMethod !== 'direct') {
                    // Biga 24h Total: Start Today Evening, Bake Tomorrow Evening
                    mixTime = subH(targetDate, 5); // Short bulk after mix
                    mixTime = applyWork(mixTime);
                    bigaTime = subH(mixTime, 18);
                    steps.push({t: bigaTime, txt: "ğŸ¥£ ×”×›× ×ª ×‘×™×’×”", id: "pref"});
                } else {
                    mixTime = applyWork(mixTime);
                }
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×”×›× ×ª ×‘×¦×§ ×¢×™×§×¨×™", id: "mix"});
                
                if (currentMethod === 'direct') {
                     steps.push({t: new Date(mixTime.getTime() + 3600000), txt: "ğŸ”´ ×›×“×¨×•×¨ (×œ××§×¨×¨)", id: "ball"});
                     steps.push({t: subH(targetDate, 1.5), txt: "ğŸŒ¡ï¸ ×”×•×¦××” ××”××§×¨×¨", id: "pull"});
                } else {
                     steps.push({t: subH(targetDate, 4), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
                }

            } else { // 1day
                mixTime = subH(targetDate, 5);
                mixTime = applyWork(mixTime);
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×œ×™×©×”", id: "mix"});
                steps.push({t: subH(targetDate, 4), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
            }
        } 
        else { // Romana / NY
            if (schedMode === '3day') mixTime = subH(targetDate, 48);
            else if (schedMode === '2day') mixTime = subH(targetDate, 24);
            else mixTime = subH(targetDate, 5);

            mixTime = applyWork(mixTime);
            steps.push({t: mixTime, txt: "ğŸ—ï¸ ×œ×™×©×” + ××§×¨×¨ (×›×’×•×©)", id: "mix"});

            if (currentStyle === 'romana') {
                steps.push({t: subH(targetDate, 4), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
                steps.push({t: subH(targetDate, 0.5), txt: "ğŸªµ ×¨×™×“×•×“", id: "roll"});
            } else { // NY
                if (schedMode === '1day') steps.push({t: subH(targetDate, 4), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
                else {
                    steps.push({t: subH(targetDate, 24), txt: "ğŸ”´ ×›×“×¨×•×¨ + ×—×–×¨×” ×œ××§×¨×¨", id: "ball"});
                    steps.push({t: subH(targetDate, 1.5), txt: "ğŸŒ¡ï¸ ×”×•×¦××”", id: "pull"});
                }
            }
        }

        steps.sort((a,b) => a.t - b.t);
        
        // VALIDATION
        const now = new Date();
        const firstStep = steps[0];
        let hasError = false;
        let errorMsg = "";

        // Past check
        if (firstStep.t < now) {
            const diffHrs = Math.round((now - firstStep.t)/36e5);
            hasError = true;
            errorMsg = `âš ï¸ <b>×¤×¡×¤×¡×ª ××ª ×”×–××Ÿ!</b><br>×œ×¤×™ ×”×œ×•"×–, ×”×™×™×ª ×¦×¨×™×š ×œ×”×ª×—×™×œ ×œ×¤× ×™ ${diffHrs} ×©×¢×•×ª.<br>×”×–×– ××ª ×”×ª××¨×™×š ××• ×‘×—×¨ ×ª×”×œ×™×š ×§×¦×¨ ×™×•×ª×¨.`;
        }

        // Short + Work check
        if (schedMode === '1day' && workMode === 'work') {
            const minTimeNeeded = 5 * 3600000;
            if (mixTime.getTime() + minTimeNeeded > targetDate.getTime()) {
                hasError = true;
                errorMsg = `âš ï¸ <b>××™×Ÿ ××¡×¤×™×§ ×–××Ÿ!</b><br>×¢×‘×•×“×” ×¢×“ 17:00 ×•×¤×™×¦×” ×‘-${targetDate.getHours()}:${targetDate.getMinutes()} ×–×” ×¦×¤×•×£ ××“×™ ×œ×ª×”×œ×™×š ×§×¦×¨.`;
            }
        }

        if (hasError) {
            errorBox.style.display = 'block';
            errorBox.innerHTML = errorMsg;
            mainContent.style.display = 'none'; 
        } else {
            renderSchedule(steps);
            renderRecipe(totalFlour, water, yeast, salt, oil, sugar, malt, flourName);
        }
    }

    function renderSchedule(steps) {
        const styleName = {napoli: '× ××¤×•×œ×™×˜× ×™×ª', romana: '×¨×•×××™×ª', ny: '× ×™×•-×™×•×¨×§'}[currentStyle];
        let html = `<h3 style="margin:0 0 10px 0;">ğŸ“… ×œ×•"×– (${styleName})</h3>`;
        
        // Use Hebrew Letters with correct Geresh
        const dayLetters = ['××³','×‘×³','×’×³','×“×³','×”×³','×•×³','×©×³'];

        steps.forEach((s, idx) => {
            const isChecked = checkedSteps[s.id] ? 'checked' : '';
            if (idx > 0) {
                const diffHrs = (s.t - steps[idx-1].t) / 36e5;
                if(diffHrs >= 0.5) html += `<div class="time-gap">â¬‡ ${Math.round(diffHrs*10)/10} ×©×¢×•×ª</div>`;
            }
            
            const d = s.t;
            const dayName = dayLetters[d.getDay()];
            const time = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            
            // Calc badge
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const check = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const diff = Math.round((check - today) / (1000 * 60 * 60 * 24));
            
            let badgeClass = "";
            let label = "";
            if(diff === 0) { badgeClass = "today"; label = "×”×™×•×"; }
            else if(diff === 1) { badgeClass = "tomorrow"; label = "××—×¨"; }
            else { label = `×™×•× ${dayName}`; }

            html += `<div class="checklist-item ${isChecked}" onclick="toggleStep('${s.id}')">
                <div class="check-icon">${isChecked ? 'âœ…' : 'â¬œ'}</div>
                <div class="step-txt">${s.txt}</div>
                <div class="meta-group">
                    <span class="day-badge ${badgeClass}">${label}</span>
                    ${time}
                </div>
            </div>`;
        });
        document.getElementById('scheduleArea').innerHTML = html;
    }

    // [Recipe, Menu, Saving logic remains standard...]
    function renderRecipe(flour, water, yeast, salt, oil, sugar, malt, flourName) {
        let html = `<h3 style="margin:0 0 10px 0;">ğŸ• ××ª×›×•×Ÿ</h3>`;
        let yeastLabel = document.getElementById('yeastType').value === 'fresh' ? '×©××¨×™× ×˜×¨×™×™×' : '×©××¨×™× ×™×‘×©×™×';
        let flourDisp = flourName.split(" (")[0];

        if (currentStyle === 'napoli' && currentMethod !== 'direct') {
            let pFlour = round5(flour); 
            if(currentMethod === 'poolish') pFlour = round5(flour * 0.3);
            let mFlour = flour - pFlour;
            let pWater = round5(pFlour * (currentMethod==='biga'?0.45:1.0));
            let mWater = water - pWater;
            
            html += row(`×§××— (${flourDisp})`, pFlour, "×œ××§×“×™×");
            html += row("××™×", pWater, "×œ××§×“×™×");
            html += row(yeastLabel, yeast, "×œ××§×“×™×");
            html += `<hr style="border:0; border-top:1px dashed #ddd; margin:8px 0;">`;
            if(mFlour>0) html += row("×§××— × ×•×¡×£", mFlour);
            html += row("××™× × ×•×¡×¤×™×", mWater, "×§×¨×™× ×××•×“");
            html += row("××œ×—", salt);
            if(malt > 0) html += row("×œ×ª×ª (Malt)", malt);
        } else {
            if(currentStyle === 'romana') {
                html += row("×§××— ×œ×‘×Ÿ (00)", round5(flour*0.7));
                html += row("×§××— ×¡××•×œ×™× ×”", round5(flour*0.3));
            } else if (currentStyle === 'ny') {
                html += row("×§××— ×œ×—×", round5(flour*0.7));
                html += row("×§××— ×¨×‘-×ª×›×œ×™×ª×™", round5(flour*0.3));
            } else {
                html += row(`×§××— (${flourDisp})`, flour);
            }
            html += row("××™×", water, "×§×¨×™×");
            html += row(yeastLabel, yeast);
            html += row("××œ×—", salt);
            if(oil > 0) html += row("×©××Ÿ ×–×™×ª", oil);
            if(sugar > 0) html += row("×¡×•×›×¨", sugar);
        }
        document.getElementById('recipeArea').innerHTML = html;
    }

    function row(lbl, val, note="") {
        return `<div class="row"><span class="row-label">${lbl} ${note ? `<small style="color:#90a4ae">(${note})</small>` : ''}</span><span class="row-value">${val} ×’×¨×</span></div>`;
    }

    function toggleStep(id) { checkedSteps[id] = !checkedSteps[id]; calc(); }
    function openAddPizzaModal() { document.getElementById('addPizzaModal').style.display='flex'; }
    function closeAddPizzaModal() { document.getElementById('addPizzaModal').style.display='none'; }
    function saveNewPizza() {
        const name = document.getElementById('newPizzaName').value;
        if(!name) return;
        customPizzas.push({ id: 'c_'+Date.now(), name: name, icon: 'ğŸ•', ing: {} });
        saveData(); initMenu(); closeAddPizzaModal();
    }
    const pizzaMenu = [
        { id: 'marinara', name: '××¨×™× ×¨×”', icon: 'ğŸ…', ing: { sauce: 90, garlic: 1, oregano: 1 } },
        { id: 'margherita', name: '××¨×’×¨×™×˜×”', icon: 'ğŸ§€', ing: { sauce: 90, mozzarella: 100, basil: 5, parmesan: 5 } },
        { id: 'zucchini', name: '×–×•×§×™× ×™', icon: 'ğŸ¥’', ing: { zucchini: 0.5, rosemary: 1, mozzarella: 50 } },
        { id: 'pepperoni', name: '×¤×¤×¨×•× ×™', icon: 'ğŸ¥“', ing: { sauce: 90, mozzarella: 100, pepperoni: 40 } },
        { id: 'potato', name: '×ª×¤"×', icon: 'ğŸ¥”', ing: { potato: 1, parmesan: 15, guanciale: 40, mozzarella: 50 } },
        { id: 'garlic', name: '×©×•× ×—×¨×™×£', icon: 'ğŸŒ¶ï¸', ing: { garlic: 2, chili: 0.5 } }
    ];
    function initMenu() {
        const list = document.getElementById('menuList'); list.innerHTML = "";
        [...pizzaMenu, ...customPizzas].forEach(p => {
            list.innerHTML += `<div class="menu-item"><span class="menu-name">${p.icon} ${p.name}</span><div class="menu-controls"><button class="qty-btn" onclick="changeQty('${p.id}',-1)">-</button><span class="qty-val" id="count-${p.id}">${menuCounts[p.id]||0}</span><button class="qty-btn" onclick="changeQty('${p.id}',1)">+</button></div></div>`;
        });
    }
    function changeQty(id, d) {
        if(!menuCounts[id]) menuCounts[id]=0;
        if(menuCounts[id]+d >=0) { menuCounts[id]+=d; document.getElementById(`count-${id}`).innerText=menuCounts[id]; saveData(); updateMenuStatus(); }
    }
    function updateMenuStatus() { }
    function generateShopping() {
        let totalIng = {};
        const dict = { sauce: "×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª", mozzarella: "××•×¦×¨×œ×”", garlic: "×©×•×", oregano: "××•×¨×’× ×•", basil: "×‘×–×™×œ×™×§×•×", parmesan: "×¤×¨××–'×Ÿ", zucchini: "×–×•×§×™× ×™", rosemary: "×¨×•×–××¨×™×Ÿ", pepperoni: "×¤×¤×¨×•× ×™", potato: "×ª×¤×•×— ××“××”", guanciale: "×’×•×•×× ×¦'×œ×”", chili: "×¦'×™×œ×™" };
        [...pizzaMenu, ...customPizzas].forEach(p => { const c = menuCounts[p.id] || 0; if (c > 0) for (const [k, v] of Object.entries(p.ing)) totalIng[k] = (totalIng[k] || 0) + (v * c); });
        
        let html = "";
        for (const [k, v] of Object.entries(totalIng)) html += `<div class="checklist-item" onclick="this.classList.toggle('checked'); this.querySelector('.check-icon').innerText = this.classList.contains('checked') ? 'âœ…' : 'â¬œ'"><div class="shop-text" style="flex-grow:1">${dict[k] || k}</div><div class="check-icon">â¬œ</div></div>`;
        customPizzas.forEach(p => { if(menuCounts[p.id] > 0) html += `<div class="checklist-item" onclick="this.classList.toggle('checked')"><div class="shop-text" style="flex-grow:1">××¦×¨×›×™× ×œ-${p.name}</div><div class="check-icon">â¬œ</div></div>`; });
        
        document.getElementById('shopList').innerHTML = html || "×œ× × ×‘×—×¨×• ×¤×™×¦×•×ª";
        document.getElementById('shoppingResult').style.display = 'block';
        document.getElementById('shoppingResult').scrollIntoView({behavior:'smooth'});
    }
    function shareWhatsApp() {
        let txt = "*×¨×©×™××ª ×§× ×™×•×ª ×œ×¤×™×¦×” (Pizza Ops)* ğŸ•\n\n";
        let totalIng = {};
        const dict = { sauce: "×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª", mozzarella: "××•×¦×¨×œ×”", garlic: "×©×•×", oregano: "××•×¨×’× ×•", basil: "×‘×–×™×œ×™×§×•×", parmesan: "×¤×¨××–'×Ÿ", zucchini: "×–×•×§×™× ×™", rosemary: "×¨×•×–××¨×™×Ÿ", pepperoni: "×¤×¤×¨×•× ×™", potato: "×ª×¤×•×— ××“××”", guanciale: "×’×•×•×× ×¦'×œ×”", chili: "×¦'×™×œ×™" };
        [...pizzaMenu, ...customPizzas].forEach(p => { const c = menuCounts[p.id] || 0; if (c > 0) for (const [k, v] of Object.entries(p.ing)) totalIng[k] = (totalIng[k] || 0) + (v * c); });
        
        for (const [k, v] of Object.entries(totalIng)) txt += `âœ… ${dict[k] || k}\n`;
        customPizzas.forEach(p => { if(menuCounts[p.id] > 0) txt += `âœ… ××¦×¨×›×™× ×œ-${p.name}\n`; });
        
        if (!Object.keys(totalIng).length && !customPizzas.some(p => menuCounts[p.id]>0)) return alert("×‘×—×¨ ×¤×™×¦×•×ª ×§×•×“×!");
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
    }
    function saveData() {
        const d = {
            inputs: {
                balls: document.getElementById('balls').value,
                weight: document.getElementById('weight').value,
                hyd: document.getElementById('hydration').value,
                salt: document.getElementById('saltPct').value,
                oil: document.getElementById('oilPct').value,
                sugar: document.getElementById('sugarPct').value,
                yeast: document.getElementById('yeastPct').value,
                malt: document.getElementById('maltPct').value,
                work: document.getElementById('workMode').value,
                date: document.getElementById('targetTime').value,
                flour: document.getElementById('flourMix').value
            },
            style: currentStyle,
            method: currentMethod,
            counts: menuCounts,
            checks: checkedSteps,
            customPizzas: customPizzas
        };
        localStorage.setItem('pizzaOpsV21', JSON.stringify(d));
    }
    function loadData() {
        const d = JSON.parse(localStorage.getItem('pizzaOpsV21'));
        if (d) {
            if(d.inputs) {
                for(let k in d.inputs) {
                    const el = document.getElementById(k==='date'?'targetTime': k==='work'?'workMode': k==='flour'?'flourMix' : k==='salt'?'saltPct' : k==='oil'?'oilPct' : k==='sugar'?'sugarPct' : k==='yeast'?'yeastPct' : k==='malt'?'maltPct' : k);
                    if(el) el.value = d.inputs[k];
                }
            }
            if(d.style) switchStyle(d.style);
            if(d.style === 'napoli' && d.method) setMethod(d.method);
            if(d.counts) menuCounts = d.counts;
            if(d.checks) checkedSteps = d.checks;
            if(d.customPizzas) customPizzas = d.customPizzas;
        }
    }
    function getWeather() {
        if (!navigator.geolocation) return alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×§×•×");
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                const data = await res.json();
                document.getElementById('roomTemp').value = Math.round(data.current_weather.temperature);
                calc();
                alert(`×”×˜××¤×¨×˜×•×¨×” ×¢×•×“×›× ×”: ${data.current_weather.temperature}Â°C`);
            } catch(e) { alert("×©×’×™××” ×‘×§×‘×œ×ª ××–×’ ××•×•×™×¨"); }
        }, () => alert("×™×© ×œ××©×¨ ×’×™×©×” ×œ××™×§×•×"));
    }
    function resetApp() { localStorage.removeItem('pizzaOpsV21'); location.reload(); }

    init();
</script>
</body>
</html>
