<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pizza Ops">
    <meta name="theme-color" content="#d32f2f">
    
    <meta property="og:title" content="Pizza Ops">
    <meta property="og:type" content="website">

    <title>Pizza Ops v10.0</title>
    
    <link rel="shortcut icon" href="https://em-content.zobj.net/source/apple/391/pizza_1f355.png?v=10.0">
    <link rel="icon" type="image/png" href="https://em-content.zobj.net/source/apple/391/pizza_1f355.png?v=10.0">
    <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/391/pizza_1f355.png?v=10.0">

    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root { 
            --primary: #d32f2f; 
            --accent: #1565c0; 
            --bg: #f4f6f8; 
            --card: #ffffff; 
            --text: #37474f; 
        }
        
        body { 
            font-family: 'Heebo', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            margin: 0; 
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        .container { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 2px 15px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            width: 100%; 
            max-width: 500px; 
        }
        
        h1 { margin-top: 0; text-align: center; color: var(--primary); font-size: 2rem; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; }
        
        /* STYLE SELECTOR */
        .style-tabs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; background: #eceff1; padding: 5px; border-radius: 12px; }
        .style-tab { text-align: center; padding: 10px 5px; cursor: pointer; border-radius: 8px; font-size: 0.9rem; font-weight: 500; color: #78909c; transition: 0.2s; }
        .style-tab.active { background: #fff; color: var(--text); font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .style-icon { display: block; font-size: 1.4rem; margin-bottom: 4px; }

        /* FLOUR INFO BOX */
        .flour-info { background: #e8f5e9; border: 1px solid #c8e6c9; color: #2e7d32; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; font-weight: 500; text-align: center; display: none; direction: rtl; }

        /* Method Selector */
        .method-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .method-opt { border: 1px solid #cfd8dc; padding: 10px 5px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 500; color: #78909c; transition: all 0.2s; font-size: 0.9rem; background: #fff; }
        .method-opt.active { background-color: var(--primary); color: white; border-color: var(--primary); font-weight: 700; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.2); transform: translateY(-1px); }
        
        /* INPUTS & SELECT FIXES */
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #cfd8dc; 
            border-radius: 8px; 
            font-size: 1rem; 
            margin-top: 5px; 
            background-color: #fff; 
            font-family: 'Heebo', sans-serif; 
            color: #333; 
            max-width: 100%;
        }
        
        select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: left 12px top 50%;
            background-size: 10px auto;
            padding-left: 30px; 
            text-align: right;
            cursor: pointer;
        }

        input:focus, select:focus { border-color: var(--accent); outline: none; }
        label { margin-top: 15px; display: block; font-weight: 600; font-size: 0.9rem; color: #546e7a; }

        #targetTime { direction: ltr; text-align: center; max-width: 100%; display: block; -webkit-appearance: none; min-height: 45px; }

        .timeline-select { background-color: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; font-weight: 700; }
        .work-constraint { background-color: #fff3e0; border: 1px solid #ffe0b2; color: #e65100; font-weight: 700; }
        .temp-select { background-color: #e0f2f1; border: 1px solid #80cbc4; color: #00695c; font-weight: 700; }

        .weather-btn { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 8px; padding: 10px; width: 100%; margin-top: 5px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        
        .checklist-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px dashed #cfd8dc; cursor: pointer; transition: all 0.2s; border-radius: 6px; user-select: none; width: 100%; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item:active { background: #f5f5f5; }
        .checklist-item.checked { background: #e8f5e9; opacity: 0.8; }
        .checklist-item.checked .step-txt { text-decoration: line-through; color: #81c784; }
        
        .step-txt { flex-grow: 1; padding-right: 5px; font-size: 0.95rem; } 
        .meta-group { display: flex; align-items: center; flex-shrink: 0; }
        .check-icon { width: 24px; text-align: center; margin-left: 0; margin-right: 8px; font-size: 1.1rem; flex-shrink: 0; }
        .day-badge { font-weight: 700; background: #455a64; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-left: 5px; white-space: nowrap; }

        .row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .row-label { font-weight: 500; font-size: 1rem; color: #455a64; }
        .row-value { font-weight: 700; font-family: 'Heebo', monospace; font-size: 1.1em; color: #263238; }
        .hidden-adv { display: none; margin-top: 15px; padding-top:15px; border-top:1px dashed #cfd8dc; }
        
        .menu-grid { display: grid; gap: 10px; margin-top: 15px; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #eee; padding: 12px 15px; border-radius: 10px; transition: border-color 0.2s; }
        .menu-name { font-weight: 600; font-size: 1rem; color: #333; display: flex; align-items: center; }
        .menu-controls { display: flex; align-items: center; gap: 12px; }
        .qty-btn { width: 32px; height: 32px; background: #eceff1; border-radius: 50%; border: none; font-weight: bold; font-size: 1.2rem; cursor: pointer; color: #546e7a; display: flex; align-items: center; justify-content: center; padding-bottom: 3px; }
        .qty-val { font-weight: 700; width: 20px; text-align: center; font-size: 1.1rem; }
        
        .action-grid { margin-top:25px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        .btn-main { border:none; padding:12px; border-radius:8px; font-size:1rem; font-weight:700; cursor:pointer; color:white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 6px; }
        
        .fab-btn { position: fixed; bottom: 25px; left: 25px; background-color: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; text-align: center; line-height: 60px; font-size: 24px; box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4); cursor: pointer; z-index: 1000; transition: transform 0.2s; }
        .fab-btn:hover { transform: scale(1.1); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 16px; padding: 25px; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { font-size: 1.8rem; cursor: pointer; color: #90a4ae; }
        .qa-item { border-bottom: 1px solid #eceff1; padding: 15px 0; }
        .qa-question { font-weight: 600; cursor: pointer; color: var(--accent); display: flex; justify-content: space-between; }

        .reset-link { display:block; text-align:center; margin-top:30px; color:#ef5350; cursor:pointer; font-size:0.9rem; font-weight:500; text-decoration:none; opacity:0.7; transition:opacity 0.2s; padding-bottom: 30px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ• Pizza Ops</h1>

    <div class="style-tabs">
        <div class="style-tab active" id="tab-napoli" onclick="switchStyle('napoli')">
            <span class="style-icon">ğŸ‡®ğŸ‡¹</span>× ××¤×•×œ×™×˜× ×™×ª
        </div>
        <div class="style-tab" id="tab-romana" onclick="switchStyle('romana')">
            <span class="style-icon">ğŸ›ï¸</span>×¨×•×××™×ª
        </div>
        <div class="style-tab" id="tab-ny" onclick="switchStyle('ny')">
            <span class="style-icon">ğŸ—½</span>× ×™×•-×™×•×¨×§
        </div>
    </div>

    <div id="napoliFlourSelect" style="display:block; margin-bottom:15px;">
        <label style="margin-top:0;">ğŸŒ¾ ×‘×—×™×¨×ª ×§××—:</label>
        <select id="flourMix" onchange="saveData()">
            <option value="red_nuvola">××™×§×¡ 50/50 (××•××œ×¥)</option>
            <option value="nuvola">100% × ×•×‘×•×œ×” (××•×•×¨×™×¨×™ ×××•×“)</option>
            <option value="red">100% ×§××¤×•×˜×• ××“×•× (×§×œ××¡×™)</option>
            <option value="red_shtibel">××™×§×¡ ×©×˜×™×‘×œ (×‘×™×ª×™)</option>
        </select>
    </div>

    <div id="romanaInfo" class="flour-info">ğŸ›ï¸ ×ª×¢×¨×•×‘×ª ×¨×•×××™×ª: 70% ×§××— 00 + 30% ×¡××•×œ×™× ×”</div>
    <div id="nyInfo" class="flour-info">ğŸ—½ ×ª×¢×¨×•×‘×ª × ×™×•-×™×•×¨×§: 70% ×§××— ×œ×—× + 30% ×¨×‘-×ª×›×œ×™×ª×™</div>

    <div class="method-selector" id="methodSelectorContainer">
        <div class="method-opt" onclick="setMethod('direct')" id="btn-direct">×™×©×™×¨</div>
        <div class="method-opt" onclick="setMethod('poolish')" id="btn-poolish">×¤×•×œ×™×©</div>
        <div class="method-opt active" onclick="setMethod('biga')" id="btn-biga">Biga 100%</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label>ğŸ“… ××¡×œ×•×œ:</label>
            <select id="scheduleMode" class="timeline-select" onchange="calc()">
                <option value="1day" id="opt_sched_1">ğŸš€ 24 ×©×¢×•×ª</option>
                <option value="2day" id="opt_sched_2">ğŸŒ™ 48 ×©×¢×•×ª</option>
                <option value="3day" id="opt_sched_3" selected>â„ï¸ 72 ×©×¢×•×ª</option>
            </select>
        </div>
        <div>
            <label>ğŸ’¼ ×–××™× ×•×ª:</label>
            <select id="workMode" class="work-constraint" onchange="calc()">
                <option value="flexible">ğŸ  ×’××™×©</option>
                <option value="work" selected>ğŸ’¼ ×¢×‘×•×“×” (17:00+)</option>
            </select>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>×›××•×ª ×›×“×•×¨×™×</label><input type="number" id="balls" value="6" oninput="calc()"></div>
        <div><label>××©×§×œ ×›×“×•×¨ (×’')</label><input type="number" id="weight" value="250" oninput="calc()"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>×”×™×“×¨×¦×™×” (%)</label><input type="number" id="hydration" value="67" oninput="calc()"></div>
        <div>
            <label>ğŸŒ¡ï¸ ×˜××¤' ×—×“×¨</label>
            <input type="number" id="roomTemp" class="temp-select" value="20" oninput="calc()">
            <div class="weather-btn" onclick="getWeather()">ğŸ“¡ ×§×‘×œ ×˜××¤' × ×•×›×—×™×ª</div>
        </div>
    </div>

    <label>ğŸ•’ ××ª×™ ××•×›×œ×™×?</label>
    <input type="datetime-local" id="targetTime" onchange="calc()">

    <div id="scheduleArea" style="margin-top:25px; background:#f1f8e9; padding:10px; border-radius:12px;"></div>
    <div id="recipeArea" style="margin-top:15px; background:#fafafa; padding:15px; border-radius:12px; border:1px solid #eee;"></div>

    <div style="text-align:center; margin-top:25px; font-size:0.85rem; color:#90a4ae; cursor:pointer; text-decoration:underline;" onclick="document.getElementById('adv').style.display='block'">×”×’×“×¨×•×ª ××ª×§×“××•×ª</div>
    <div id="adv" class="hidden-adv">
        <label>××œ×— (%)</label><input type="number" id="saltPct" value="2.5" step="0.1" oninput="calc()">
        <label>×©××Ÿ (%)</label><input type="number" id="oilPct" value="0" step="0.5" oninput="calc()">
        <label>×¡×•×›×¨ (%)</label><input type="number" id="sugarPct" value="0" step="0.5" oninput="calc()">
        <label>×©××¨×™× ×‘×¡×™×¡ (%)</label><input type="number" id="yeastPct" value="0.5" step="0.1" oninput="calc()">
        <label>×œ×ª×ª/Malt (%)</label><input type="number" id="maltPct" value="1.0" step="0.1" oninput="calc()">
    </div>
</div>

<div class="container">
    <h2>ğŸ›’ ×ª×¤×¨×™×˜ ×•×§× ×™×•×ª</h2>
    <div class="status-bar">
        <span>× ×‘×—×¨×•: <strong id="totalSelected">0</strong></span>
        <span id="matchStatus"></span>
    </div>
    
    <div id="menuList" class="menu-grid"></div>

    <div class="action-grid">
        <button onclick="generateShopping()" class="btn-main" style="background:var(--accent);">ğŸ›’ ×”×¦×’ ×¨×©×™××”</button>
        <button onclick="shareWhatsApp()" class="btn-main" style="background:#25D366;">ğŸ’¬ ×©×œ×— ×‘×•×•××˜×¡××¤</button>
    </div>

    <div id="shoppingResult" style="display:none; margin-top:20px;">
        <div class="prep-guide" style="background:#fff8e1; padding:15px; border-radius:10px; border:1px solid #ffe082;">
            <h3 style="margin:0 0 10px 0; color:#f57f17;">ğŸ”ª ×”×›× ×•×ª</h3>
            <div id="prepList"></div>
        </div>
        <div class="shopping-list" style="margin-top:15px;">
            <h3 style="margin:0 0 10px 0; color:#37474f;">ğŸ“‹ ××¦×¨×›×™×</h3>
            <div id="shopList"></div>
        </div>
    </div>
    
    <div onclick="resetApp()" class="reset-link">ğŸ”„ ××™×¤×•×¡ × ×ª×•× ×™× ×•××—×™×§×ª ×”×›×œ</div>
</div>

<div class="fab-btn" onclick="document.getElementById('sosModal').style.display='flex'">ğŸ†˜</div>
<div class="modal-overlay" id="sosModal">
    <div class="modal-content">
        <div class="modal-header"><h2>ğŸ†˜ ×©××œ×•×ª × ×¤×•×¦×•×ª</h2><span class="close-btn" onclick="document.getElementById('sosModal').style.display='none'">&times;</span></div>
        <div id="qaList"></div>
    </div>
</div>

<script>
    // --- STATE ---
    let currentStyle = 'napoli';
    let currentMethod = 'biga';
    let menuCounts = {};
    let checkedSteps = {}; 

    // --- INIT ---
    function init() {
        initMenu();
        loadData();
        
        const qa = [
            {q:"×”×‘×¦×§ ×“×‘×™×§ ×‘×˜×™×¨×•×£", a:"×ª×Ÿ ×× ×•×—×” ×©×œ 10 ×“×§' ××›×•×¡×” ×•×—×–×•×¨ ×œ×œ×•×©. ××œ ×ª×•×¡×™×£ ×§××—!"},
            {q:"×”×‘×™×’×” ×™×‘×©×” ××“×™", a:"×–×” ×ª×§×™×Ÿ! ×–×” ×××•×¨ ×œ×”×™×•×ª ×¤×™×¨×•×¨×™× ×•×œ× ×‘×¦×§."},
            {q:"×”×‘×¦×§ × ×§×¨×¢ ×‘×¤×ª×™×—×”", a:"×”×’×œ×•×˜×Ÿ ××ª×•×—. ×—×›×” 30 ×“×§' ×‘×˜××¤' ×”×—×“×¨."},
            {q:"××” ×–×” ×¡××•×œ×™× ×”?", a:"×§××— ×“×•×¨×•× ×“×§. ×—×•×‘×” ×œ×¤×™×¦×” ×¨×•×××™×ª ×œ×§×¨×™×¡×¤×™×•×ª."}
        ];
        document.getElementById('qaList').innerHTML = qa.map(x => `<div class="qa-item" onclick="this.lastElementChild.style.display=this.lastElementChild.style.display=='block'?'none':'block'"><div class="qa-question">${x.q} â–¼</div><div class="qa-answer" style="display:none; margin-top:5px; color:#555;">${x.a}</div></div>`).join('');

        if(!document.getElementById('targetTime').value) {
            const t = new Date(); t.setDate(t.getDate()+2); t.setHours(20,0,0,0);
            const pad = n => n<10 ? '0'+n : n;
            document.getElementById('targetTime').value = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}T${pad(t.getHours())}:${pad(t.getMinutes())}`;
        }
        
        calc();
    }

    // --- LOGIC: STYLE SWITCHER ---
    function switchStyle(style) {
        currentStyle = style;
        document.querySelectorAll('.style-tab').forEach(e => e.classList.remove('active'));
        document.getElementById(`tab-${style}`).classList.add('active');

        // Toggle UI Elements
        const methodContainer = document.getElementById('methodSelectorContainer');
        const napoliFlour = document.getElementById('napoliFlourSelect');
        const romanaInfo = document.getElementById('romanaInfo');
        const nyInfo = document.getElementById('nyInfo');

        // Reset visibility
        methodContainer.style.display = 'none';
        napoliFlour.style.display = 'none';
        romanaInfo.style.display = 'none';
        nyInfo.style.display = 'none';

        if(style === 'napoli') {
            methodContainer.style.display = 'grid';
            napoliFlour.style.display = 'block';
            setMethod('biga');
            
            // Napoli Defaults
            document.getElementById('balls').value = 6;
            document.getElementById('weight').value = 250;
            document.getElementById('hydration').value = 67;
            document.getElementById('saltPct').value = 2.5;
            document.getElementById('oilPct').value = 0;
            document.getElementById('sugarPct').value = 0;
            document.getElementById('yeastPct').value = 0.5;

        } else if(style === 'romana') {
            romanaInfo.style.display = 'block';
            setMethod('direct');
            
            // Romana Defaults
            document.getElementById('balls').value = 4;
            document.getElementById('weight').value = 180;
            document.getElementById('hydration').value = 70;
            document.getElementById('saltPct').value = 3.5;
            document.getElementById('oilPct').value = 5.0; 
            document.getElementById('sugarPct').value = 0;
            document.getElementById('yeastPct').value = 0.5;

        } else if(style === 'ny') {
            nyInfo.style.display = 'block';
            setMethod('direct');
            
            // NY Defaults
            document.getElementById('balls').value = 4;
            document.getElementById('weight').value = 300; 
            document.getElementById('hydration').value = 65;
            document.getElementById('saltPct').value = 2.5;
            document.getElementById('oilPct').value = 2.0;
            document.getElementById('sugarPct').value = 2.0;
            document.getElementById('yeastPct').value = 0.3;
        }
        calc();
    }

    // --- LOGIC: WEATHER ---
    function getWeather() {
        if (!navigator.geolocation) return alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×§×•×");
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                const data = await res.json();
                document.getElementById('roomTemp').value = Math.round(data.current_weather.temperature);
                calc();
                alert(`×”×˜××¤×¨×˜×•×¨×” ×¢×•×“×›× ×”: ${data.current_weather.temperature}Â°C`);
            } catch(e) { alert("×©×’×™××” ×‘×§×‘×œ×ª ××–×’ ××•×•×™×¨"); }
        }, () => alert("×™×© ×œ××©×¨ ×’×™×©×” ×œ××™×§×•×"));
    }

    // --- LOGIC: CALCULATOR ---
    function calc() {
        const flourSelect = document.getElementById('flourMix');
        const flourName = flourSelect.options[flourSelect.selectedIndex].text;
        
        const p = {
            balls: +document.getElementById('balls').value,
            weight: +document.getElementById('weight').value,
            hyd: +document.getElementById('hydration').value,
            temp: +document.getElementById('roomTemp').value,
            salt: +document.getElementById('saltPct').value,
            oil: +document.getElementById('oilPct').value,
            sugar: +document.getElementById('sugarPct').value,
            yeast: +document.getElementById('yeastPct').value,
            malt: +document.getElementById('maltPct').value,
            mode: document.getElementById('scheduleMode').value,
            work: document.getElementById('workMode').value,
            date: new Date(document.getElementById('targetTime').value),
            flourType: flourName
        };

        let tempFactor = 1.0;
        let waterTip = "";
        
        // Temp Logic
        if (p.temp > 24) {
            tempFactor = p.temp >= 30 ? 0.6 : 0.8;
            waterTip = "××™× ×§×¨×™× ×××•×“ (×§×¨×—)";
        } else if (p.temp < 20) {
            tempFactor = p.temp <= 15 ? 1.4 : 1.2;
            waterTip = "××™× ×¤×•×©×¨×™× (25Â°C)";
        } else {
            waterTip = "××™× ×‘×˜××¤' ×”×—×“×¨";
        }
        
        let yPct = p.yeast * tempFactor;
        // Schedule adjustments
        if (p.mode === '1day' && currentMethod === 'direct') yPct = 0.3 * tempFactor;
        if (p.mode === '3day' && currentStyle !== 'ny') yPct = 0.5 * tempFactor; 
        
        const totalWeight = p.balls * p.weight;
        const totalPct = 100 + p.hyd + p.salt + p.oil + p.sugar + yPct + p.malt;
        
        const totalFlour = Math.round((totalWeight / totalPct) * 100);
        const water = Math.round(totalFlour * (p.hyd/100));
        const salt = Math.round(totalFlour * (p.salt/100) * 10)/10;
        const oil = Math.round(totalFlour * (p.oil/100));
        const sugar = Math.round(totalFlour * (p.sugar/100));
        const yeast = Math.round(totalFlour * (yPct/100) * 10)/10;
        const malt = Math.round(totalFlour * (p.malt/100) * 10)/10;

        // --- SCHEDULE LOGIC ---
        const subH = (d,h) => new Date(d.getTime() - (h*3600000));
        let steps = [];
        let bake = p.date;
        steps.push({t: bake, txt: "ğŸ”¥ ×–××Ÿ ××¤×™×™×”", id: "bake"});

        // 1. NAPOLI SCHEDULE
        if(currentStyle === 'napoli') {
            if (p.mode === '3day') { // 72h
                // 3 Day Napoli usually means 48h active time (Biga 24h + Bulk/Ball 24h)
                // Or true 72h? Let's stick to standard Biga 100% flow which is ~48h total
                // If user selects 72h, we extend cold ferment of the main dough
                let mixTime = subH(bake, 48); // Mix main dough 48h before bake
                let bigaTime = subH(mixTime, 24); // Make Biga 24h before mixing
                steps.push({t: bigaTime, txt: "ğŸ¥£ ×”×›× ×ª ×‘×™×’×”", id: "pref"});
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×”×›× ×ª ×‘×¦×§ ×¢×™×§×¨×™", id: "mix"});
                steps.push({t: subH(bake, 24), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
                steps.push({t: subH(bake, 3), txt: "ğŸŒ¡ï¸ ×”×•×¦××” ××”××§×¨×¨", id: "pull"});
            } else if (p.mode === '2day') { // 48h
                // Standard Biga: Biga -18h -> Mix -> Bulk -> Ball -> Bake
                let mixTime = subH(bake, 24);
                let bigaTime = subH(mixTime, 18);
                steps.push({t: bigaTime, txt: "ğŸ¥£ ×”×›× ×ª ×‘×™×’×”/×¤×•×œ×™×©", id: "pref"});
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×”×›× ×ª ×‘×¦×§ ×¢×™×§×¨×™", id: "mix"});
                steps.push({t: subH(bake, 4), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
            } else { // 24h
                let mixTime = subH(bake, 8); // Same day direct usually
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×œ×™×©×”", id: "mix"});
                steps.push({t: subH(bake, 4), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
            }
        }
        
        // 2. NEW YORK SCHEDULE (Cold Ferment Focused)
        else if (currentStyle === 'ny') {
            let mixTime, ballTime;
            if(p.mode === '3day') { // 72h
                mixTime = subH(bake, 72);
                ballTime = subH(bake, 24);
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×œ×™×©×” + ××§×¨×¨ (×›×’×•×©)", id: "mix"});
                steps.push({t: ballTime, txt: "ğŸ”´ ×›×“×¨×•×¨ + ×—×–×¨×” ×œ××§×¨×¨", id: "ball"});
            } else if(p.mode === '2day') { // 48h
                mixTime = subH(bake, 48);
                ballTime = subH(bake, 24);
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×œ×™×©×” + ××§×¨×¨ (×›×’×•×©)", id: "mix"});
                steps.push({t: ballTime, txt: "ğŸ”´ ×›×“×¨×•×¨ + ×—×–×¨×” ×œ××§×¨×¨", id: "ball"});
            } else { // 24h
                mixTime = subH(bake, 24);
                steps.push({t: mixTime, txt: "ğŸ—ï¸ ×œ×™×©×”", id: "mix"});
                steps.push({t: subH(bake, 6), txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
            }
            steps.push({t: subH(bake, 2), txt: "ğŸŒ¡ï¸ ×”×•×¦××” ×œ×˜××¤' ×”×—×“×¨", id: "pull"});
        }

        // 3. ROMAN SCHEDULE (Tonda - Roll out)
        else if (currentStyle === 'romana') {
            // Roman Tonda: Long bulk, ball on baking day (4-6h before)
            let mixTime;
            if(p.mode === '3day') mixTime = subH(bake, 72);
            else if(p.mode === '2day') mixTime = subH(bake, 48);
            else mixTime = subH(bake, 24);

            steps.push({t: mixTime, txt: "ğŸ—ï¸ ×œ×™×©×” + ×× ×•×—×” 10 ×“×§' + ×§×™×¤×•×œ + ××§×¨×¨ (×’×•×©)", id: "mix"});
            // Balling is always on bake day for thin roman
            steps.push({t: subH(bake, 5), txt: "ğŸ”´ ×›×“×¨×•×¨ (×œ×¤×™×¦×” ×“×§×”)", id: "ball"});
            steps.push({t: subH(bake, 0.5), txt: "ğŸªµ ×¨×™×“×•×“ ×“×§ ×¢× ××¢×¨×•×š", id: "roll"});
        }

        steps.sort((a,b) => a.t - b.t);

        const days = ['×\'','×‘\'','×’\'','×“\'','×”\'','×•\'','×©\''];
        const fmt = d => `<span class="day-badge">${days[d.getDay()]}</span> ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        
        let schedHtml = `<h3 style="margin:0 0 10px 0;">ğŸ“… ×œ×•"×– (${currentStyle === 'napoli' ? '× ××¤×•×œ×™' : currentStyle === 'romana' ? '×¨×•×××™×ª' : '× ×™×•-×™×•×¨×§'})</h3>`;
        steps.forEach(s => {
            const isChecked = checkedSteps[s.id] ? 'checked' : '';
            schedHtml += `<div class="checklist-item ${isChecked}" onclick="toggleStep('${s.id}')">
                <div class="step-txt">${s.txt}</div>
                <div class="meta-group">${fmt(s.t)} <span class="check-icon">${isChecked ? 'âœ…' : 'â¬œ'}</span></div>
            </div>`;
        });
        document.getElementById('scheduleArea').innerHTML = schedHtml;

        // --- RECIPE RENDER ---
        let rHtml = `<h3 style="margin:0 0 10px 0;">ğŸ• ××ª×›×•×Ÿ (${currentStyle === 'napoli' ? '× ××¤×•×œ×™' : currentStyle === 'romana' ? '×¨×•×××™×ª' : '× ×™×•-×™×•×¨×§'})</h3>`;
        
        let cleanFlour = p.flourType.split(" (")[0]; 

        if (currentMethod === 'biga' && currentStyle === 'napoli') {
            let pFlour = Math.round(totalFlour); 
            let pWater = Math.round(totalFlour * 0.45);
            let mainWater = water - pWater;
            rHtml += row(`×§××—: ${cleanFlour}`, pFlour);
            rHtml += row("××™× (×œ×‘×™×’×”)", pWater);
            rHtml += row("×©××¨×™×", yeast);
            rHtml += `<hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">`;
            rHtml += row(`××™× × ×•×¡×¤×™× <br><span style="font-size:0.8rem;color:#1565c0">${waterTip}</span>`, mainWater);
            rHtml += row("××œ×—", salt);
            rHtml += row("×œ×ª×ª (Malt)", malt);
        } else if (currentMethod === 'poolish') {
            let pFlour = Math.round(totalFlour * 0.3);
            let pWater = pFlour;
            let mainFlour = totalFlour - pFlour;
            let mainWater = water - pWater;
            let pYeast = 0.2; 
            rHtml += row(`×§××—: ${cleanFlour}`, pFlour);
            rHtml += row("××™× (×œ×¤×•×œ×™×©)", pWater);
            rHtml += row("×©××¨×™× (×œ×¤×•×œ×™×©)", pYeast);
            rHtml += `<hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">`;
            rHtml += row("×§××— × ×•×¡×£", mainFlour);
            rHtml += row(`××™× × ×•×¡×¤×™× <br><span style="font-size:0.8rem;color:#1565c0">${waterTip}</span>`, mainWater);
            rHtml += row("×©××¨×™× × ×•×¡×¤×™×", (yeast - pYeast).toFixed(1));
            rHtml += row("××œ×—", salt);
        } else {
            if(currentStyle === 'romana') {
                 rHtml += row("×§××— ×œ×‘×Ÿ (00)", Math.round(totalFlour * 0.7));
                 rHtml += row("×§××— ×¡××•×œ×™× ×”", Math.round(totalFlour * 0.3));
            } else if(currentStyle === 'ny') {
                 rHtml += row("×§××— ×œ×—×", Math.round(totalFlour * 0.7));
                 rHtml += row("×§××— ×¨×‘-×ª×›×œ×™×ª×™", Math.round(totalFlour * 0.3));
            } else {
                 rHtml += row(`×§××—: ${cleanFlour}`, totalFlour);
            }
            
            rHtml += row(`××™× <br><span style="font-size:0.8rem;color:#1565c0">${waterTip}</span>`, water);
            rHtml += row("×©××¨×™×", yeast);
            rHtml += row("××œ×—", salt);
            if(oil > 0) rHtml += row("×©××Ÿ ×–×™×ª", oil);
            if(sugar > 0) rHtml += row("×¡×•×›×¨", sugar);
        }
        
        document.getElementById('recipeArea').innerHTML = rHtml;
        saveData();
        updateMenuStatus();
    }

    function row(lbl, val) { return `<div class="row"><span class="row-label">${lbl}</span><span class="row-value">${val} ×’×¨×</span></div>`; }

    function toggleStep(id) {
        checkedSteps[id] = !checkedSteps[id];
        calc(); 
    }

    // --- LOGIC: MENU & SHARING ---
    const pizzaMenu = [
        { id: 'marinara', name: '××¨×™× ×¨×”', icon: 'ğŸ…', ing: { sauce: 90, garlic: 1, oregano: 1 } },
        { id: 'margherita', name: '××¨×’×¨×™×˜×”', icon: 'ğŸ§€', ing: { sauce: 90, mozzarella: 100, basil: 5, parmesan: 5 } },
        { id: 'zucchini', name: '×–×•×§×™× ×™', icon: 'ğŸ¥’', ing: { zucchini: 0.5, rosemary: 1, mozzarella: 50 } },
        { id: 'pepperoni', name: '×¤×¤×¨×•× ×™', icon: 'ğŸ¥“', ing: { sauce: 90, mozzarella: 100, pepperoni: 40 } },
        { id: 'potato', name: '×ª×¤"×', icon: 'ğŸ¥”', ing: { potato: 1, parmesan: 15, guanciale: 40, mozzarella: 50 } },
        { id: 'garlic', name: '×©×•× ×—×¨×™×£', icon: 'ğŸŒ¶ï¸', ing: { garlic: 2, chili: 0.5 } }
    ];

    function initMenu() {
        const list = document.getElementById('menuList');
        list.innerHTML = pizzaMenu.map(p => `
            <div class="menu-item">
                <span class="menu-name">${p.icon} ${p.name}</span>
                <div class="menu-controls">
                    <button class="qty-btn" onclick="changeQty('${p.id}', -1)">-</button>
                    <span class="qty-val" id="count-${p.id}">0</span>
                    <button class="qty-btn" onclick="changeQty('${p.id}', 1)">+</button>
                </div>
            </div>`).join('');
    }

    function changeQty(id, d) {
        if (!menuCounts[id]) menuCounts[id] = 0;
        if (menuCounts[id] + d >= 0) {
            menuCounts[id] += d;
            document.getElementById(`count-${id}`).innerText = menuCounts[id];
            saveData();
            updateMenuStatus();
        }
    }

    function updateMenuStatus() {
        const total = Object.values(menuCounts).reduce((a,b)=>a+b, 0);
        document.getElementById('totalSelected').innerText = total;
        const balls = +document.getElementById('balls').value;
        const el = document.getElementById('matchStatus');
        if(total === balls) { el.innerText = "âœ… ×‘×•×œ!"; el.style.color="#81c784"; }
        else if(total > balls) { el.innerText = `âŒ ×—×¨×™×’×” (${total-balls})`; el.style.color="#ef5350"; }
        else { el.innerText = `âš ï¸ × ×•×ª×¨ (${balls-total})`; el.style.color="#ffb74d"; }
    }

    function generateShopping() {
        let totalIng = {};
        const dict = { sauce: "×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª", mozzarella: "××•×¦×¨×œ×”", garlic: "×©×•×", oregano: "××•×¨×’× ×•", basil: "×‘×–×™×œ×™×§×•×", parmesan: "×¤×¨××–'×Ÿ", zucchini: "×–×•×§×™× ×™", rosemary: "×¨×•×–××¨×™×Ÿ", pepperoni: "×¤×¤×¨×•× ×™", potato: "×ª×¤×•×— ××“××”", guanciale: "×’×•×•×× ×¦'×œ×”", chili: "×¦'×™×œ×™" };
        
        pizzaMenu.forEach(p => {
            const c = menuCounts[p.id] || 0;
            if (c > 0) {
                for (const [k, v] of Object.entries(p.ing)) {
                    totalIng[k] = (totalIng[k] || 0) + (v * c);
                }
            }
        });

        // Add Style Specific Ingredients
        if(currentStyle === 'romana') {
            totalIng['semolina'] = 1;
            totalIng['oil'] = 1;
        }
        if(currentStyle === 'ny') {
            totalIng['sugar'] = 1;
            totalIng['oil'] = 1;
            totalIng['ap_flour'] = 1;
        }
        const extraDict = { semolina: "×§××— ×¡××•×œ×™× ×”", oil: "×©××Ÿ ×–×™×ª", sugar: "×¡×•×›×¨ ×œ×‘×Ÿ", ap_flour: "×§××— ×¨×‘-×ª×›×œ×™×ª×™" };

        let html = "";
        for (const [k, v] of Object.entries(totalIng)) {
            html += `<div class="checklist-item"><div class="shop-text" style="flex-grow:1">${dict[k] || extraDict[k] || k}</div><div class="check-icon">â¬œ</div></div>`;
        }
        document.getElementById('shopList').innerHTML = html || "×œ× × ×‘×—×¨×• ×¤×™×¦×•×ª";
        document.getElementById('shoppingResult').style.display = 'block';
        document.getElementById('shoppingResult').scrollIntoView({behavior:'smooth'});
        
        let prepHtml = "";
        if(totalIng.potato) prepHtml += `<div class="checklist-item"><div class="step-txt">ğŸ¥” ×œ×¤×¨×•×¡ ×ª×¤"× ×“×§ ×•×œ×”×©×¨×•×ª ×‘××™×</div></div>`;
        if(totalIng.zucchini) prepHtml += `<div class="checklist-item"><div class="step-txt">ğŸ¥’ ×œ×¤×¨×•×¡ ×–×•×§×™× ×™ ×•×œ×”××œ×™×— (×”×’×¨×ª × ×•×–×œ×™×)</div></div>`;
        if(totalIng.sauce) prepHtml += `<div class="checklist-item"><div class="step-txt">ğŸ… ×œ×”×›×™×Ÿ ×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª</div></div>`;
        if(currentStyle === 'romana') prepHtml += `<div class="checklist-item"><div class="step-txt">ğŸªµ ×œ×”×›×™×Ÿ ××¢×¨×•×š (×¨×•×××™×ª)</div></div>`;
        
        document.getElementById('prepList').innerHTML = prepHtml || "××™×Ÿ ×”×›× ×•×ª ××™×•×—×“×•×ª";
    }

    function shareWhatsApp() {
        let txt = "*×¨×©×™××ª ×§× ×™×•×ª ×œ×¤×™×¦×” (Pizza Ops)* ğŸ•\n\n";
        
        let totalIng = {};
        const dict = { sauce: "×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª", mozzarella: "××•×¦×¨×œ×”", garlic: "×©×•×", oregano: "××•×¨×’× ×•", basil: "×‘×–×™×œ×™×§×•×", parmesan: "×¤×¨××–'×Ÿ", zucchini: "×–×•×§×™× ×™", rosemary: "×¨×•×–××¨×™×Ÿ", pepperoni: "×¤×¤×¨×•× ×™", potato: "×ª×¤×•×— ××“××”", guanciale: "×’×•×•×× ×¦'×œ×”", chili: "×¦'×™×œ×™" };
        pizzaMenu.forEach(p => {
            const c = menuCounts[p.id] || 0;
            if (c > 0) for (const [k, v] of Object.entries(p.ing)) totalIng[k] = (totalIng[k] || 0) + (v * c);
        });

        if(currentStyle === 'romana') {
            totalIng['semolina'] = 1;
            totalIng['oil'] = 1;
        }
        if(currentStyle === 'ny') {
            totalIng['sugar'] = 1;
            totalIng['oil'] = 1;
            totalIng['ap_flour'] = 1;
        }
        const extraDict = { semolina: "×§××— ×¡××•×œ×™× ×”", oil: "×©××Ÿ ×–×™×ª", sugar: "×¡×•×›×¨ ×œ×‘×Ÿ", ap_flour: "×§××— ×¨×‘-×ª×›×œ×™×ª×™" };

        if (Object.keys(totalIng).length === 0) return alert("×‘×—×¨ ×¤×™×¦×•×ª ×§×•×“×!");

        for (const [k, v] of Object.entries(totalIng)) {
            txt += `âœ… ${dict[k] || extraDict[k] || k}\n`;
        }
        
        const balls = document.getElementById('balls').value;
        const styleName = currentStyle === 'napoli' ? '× ××¤×•×œ×™' : currentStyle === 'romana' ? '×¨×•×××™×ª' : '× ×™×•-×™×•×¨×§';
        
        txt += `\n*×‘×¦×§ (${balls} ×›×“×•×¨×™×, ×¡×’× ×•×Ÿ ${styleName}):*\n`;
        
        if(currentStyle === 'napoli') {
             const fType = document.getElementById('flourMix').options[document.getElementById('flourMix').selectedIndex].text.split(" (")[0];
             txt += `ğŸŒ¾ ${fType}\n`;
        } else if (currentStyle === 'romana') {
             txt += `ğŸŒ¾ ×§××— 00 + ×¡××•×œ×™× ×”\n`;
        } else {
             txt += `ğŸŒ¾ ×§××— ×œ×—× + ×¨×‘ ×ª×›×œ×™×ª×™\n`;
        }
        
        txt += `ğŸŒ¾ ×©××¨×™×`;

        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
    }

    // --- DATA ---
    function saveData() {
        const d = {
            inputs: {
                balls: document.getElementById('balls').value,
                weight: document.getElementById('weight').value,
                hyd: document.getElementById('hydration').value,
                temp: document.getElementById('roomTemp').value,
                date: document.getElementById('targetTime').value,
                salt: document.getElementById('saltPct').value,
                oil: document.getElementById('oilPct').value,
                sugar: document.getElementById('sugarPct').value,
                yeast: document.getElementById('yeastPct').value,
                malt: document.getElementById('maltPct').value,
                sched: document.getElementById('scheduleMode').value,
                work: document.getElementById('workMode').value,
                flour: document.getElementById('flourMix').value
            },
            method: currentMethod,
            style: currentStyle,
            counts: menuCounts,
            checks: checkedSteps
        };
        localStorage.setItem('pizzaOpsV10', JSON.stringify(d));
    }

    function loadData() {
        const d = JSON.parse(localStorage.getItem('pizzaOpsV10'));
        if (d) {
            if(d.inputs) {
                for(let k in d.inputs) {
                    const el = document.getElementById({balls:'balls', weight:'weight', hyd:'hydration', temp:'roomTemp', date:'targetTime', salt:'saltPct', oil:'oilPct', sugar:'sugarPct', yeast:'yeastPct', malt:'maltPct', sched:'scheduleMode', work:'workMode', flour:'flourMix'}[k]);
                    if(el) el.value = d.inputs[k];
                }
            }
            if(d.style) switchStyle(d.style);
            if(d.style === 'napoli' && d.method) setMethod(d.method);
            
            if(d.counts) menuCounts = d.counts;
            if(d.checks) checkedSteps = d.checks;
            
            // UI Update
            for (const [id, c] of Object.entries(menuCounts)) {
                const el = document.getElementById(`count-${id}`);
                if(el) el.innerText = c;
            }
        }
    }

    function setMethod(m) {
        currentMethod = m;
        document.querySelectorAll('.method-opt').forEach(e => e.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
        calc();
    }

    function resetApp() {
        if(confirm("×‘×˜×•×— ×©×¨×•×¦×™× ×œ××¤×¡ ×”×›×œ?")) {
            localStorage.removeItem('pizzaOpsV10');
            location.reload();
        }
    }

    init();
</script>
</body>
</html>
