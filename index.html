<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pizza Ops">
    <meta name="theme-color" content="#d32f2f">
    
    <meta property="og:title" content="Pizza Ops">
    <meta property="og:description" content="××—×©×‘×•×Ÿ ×¤×™×¦×” ×—×›×">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/5930/5930358.png">
    <meta property="og:type" content="website">

    <title>Pizza Ops v6.2</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/5930/5930358.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5930/5930358.png">

    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* GLOBAL RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --primary: #d32f2f;
            --accent: #1565c0;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #37474f;
            --success: #2e7d32;
        }
        body { font-family: 'Heebo', sans-serif; background-color: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 100px; }
        
        .container { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); margin-bottom: 20px; width: 100%; }
        
        h1 { margin-top: 0; text-align: center; color: var(--primary); font-size: 2rem; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; }
        h2 { font-size: 1.25rem; margin-top: 0; color: var(--text); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; font-weight: 700; }
        
        /* Inputs & Selectors */
        .method-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .method-opt { border: 1px solid #cfd8dc; padding: 10px 5px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 500; color: #78909c; transition: all 0.2s; font-size: 0.9rem; background: #fff; }
        .method-opt.active { background-color: var(--primary); color: white; border-color: var(--primary); font-weight: 700; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.2); transform: translateY(-1px); }
        
        input, select { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 1rem; margin-top: 5px; background: #fff; font-family: 'Heebo', sans-serif; color: var(--text); max-width: 100%; }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        label { margin-top: 15px; display: block; font-weight: 600; font-size: 0.9rem; color: #546e7a; }

        /* --- DATE INPUT FIX --- */
        #targetTime {
            direction: ltr; /* Fixes iOS overflow issue */
            text-align: center;
            max-width: 100%;
            display: block;
            -webkit-appearance: none; /* Removes iOS default styling */
            min-height: 45px;
        }

        /* Feature Classes */
        .timeline-select { background: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; font-weight: 700; }
        .work-constraint { background: #fff3e0; border: 1px solid #ffe0b2; color: #e65100; font-weight: 700; }
        .temp-select { background: #e0f2f1; border: 1px solid #80cbc4; color: #00695c; font-weight: 700; }

        .weather-btn { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 8px; padding: 10px; width: 100%; margin-top: 5px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .weather-btn:active { background: #bbdefb; transform: scale(0.98); }

        /* Checklist Styles */
        .checklist-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px dashed #cfd8dc; cursor: pointer; transition: all 0.2s; border-radius: 6px; user-select: none; width: 100%; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item:active { background: #f5f5f5; }
        .checklist-item.checked { background: #e8f5e9; opacity: 0.8; }
        
        .step-txt { flex-grow: 1; padding-right: 5px; font-size: 0.95rem; } 
        .checklist-item.checked .step-txt { text-decoration: line-through; color: #81c784; }
        
        .meta-group { display: flex; align-items: center; flex-shrink: 0; }
        .check-icon { width: 24px; text-align: center; margin-left: 0; margin-right: 8px; font-size: 1.1rem; flex-shrink: 0; }
        .day-badge { font-weight: 700; background: #455a64; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-left: 5px; white-space: nowrap; }

        /* Video Styles */
        .video-form { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        .video-grid { display: grid; gap: 15px; }
        .video-card { display: flex; background: #fff; border: 1px solid #eee; border-radius: 10px; overflow: hidden; height: 90px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .video-thumb { width: 120px; height: 100%; object-fit: cover; background: #000; flex-shrink: 0; }
        .video-content { padding: 8px 12px; display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; min-width: 0; }
        .video-title { font-weight: 600; font-size: 0.9rem; line-height: 1.2; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; text-decoration: none; color: #333; }
        .video-footer { display: flex; justify-content: space-between; align-items: center; }
        .video-tag { font-size: 0.75rem; background: #eceff1; padding: 2px 8px; border-radius: 4px; color: #546e7a; font-weight: 500; }
        .delete-vid { color: #ef5350; font-size: 1.1rem; cursor: pointer; padding: 5px; }
        
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: #eee; font-size: 0.85rem; font-weight: 600; color: #546e7a; cursor: pointer; white-space: nowrap; border: 1px solid transparent; transition: 0.2s; }
        .filter-chip.active { background: var(--text); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* Rows */
        .row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .row-label { font-weight: 500; font-size: 1rem; color: #455a64; }
        .row-value { font-weight: 700; font-family: 'Heebo', monospace; font-size: 1.1em; color: #263238; }
        .hidden-adv { display: none; margin-top: 15px; padding-top:15px; border-top:1px dashed #cfd8dc; }
        
        /* Menu */
        .menu-grid { display: grid; gap: 10px; margin-top: 15px; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #eee; padding: 12px 15px; border-radius: 10px; transition: border-color 0.2s; }
        .menu-name { font-weight: 600; font-size: 1rem; color: #333; display: flex; align-items: center; }
        .menu-controls { display: flex; align-items: center; gap: 12px; }
        .qty-btn { width: 32px; height: 32px; background: #eceff1; border-radius: 50%; border: none; font-weight: bold; font-size: 1.2rem; cursor: pointer; color: #546e7a; display: flex; align-items: center; justify-content: center; padding-bottom: 3px; }
        .qty-val { font-weight: 700; width: 20px; text-align: center; font-size: 1.1rem; }
        
        /* Actions */
        .action-grid { margin-top:25px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        .btn-main { border:none; padding:12px; border-radius:8px; font-size:1rem; font-weight:700; cursor:pointer; color:white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 6px; }
        
        .fab-btn { position: fixed; bottom: 25px; left: 25px; background-color: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; text-align: center; line-height: 60px; font-size: 24px; box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4); cursor: pointer; z-index: 1000; transition: transform 0.2s; }
        .fab-btn:hover { transform: scale(1.1); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 16px; padding: 25px; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { font-size: 1.8rem; cursor: pointer; color: #90a4ae; }
        .qa-item { border-bottom: 1px solid #eceff1; padding: 15px 0; }
        .qa-question { font-weight: 600; cursor: pointer; color: var(--accent); display: flex; justify-content: space-between; }

        .reset-link { display:block; text-align:center; margin-top:30px; color:#ef5350; cursor:pointer; font-size:0.9rem; font-weight:500; text-decoration:none; opacity:0.7; transition:opacity 0.2s; padding-bottom: 30px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ• Pizza Ops</h1>

    <div class="method-selector">
        <div class="method-opt" onclick="setMethod('direct')" id="btn-direct">×™×©×™×¨</div>
        <div class="method-opt" onclick="setMethod('poolish')" id="btn-poolish">×¤×•×œ×™×©</div>
        <div class="method-opt active" onclick="setMethod('biga')" id="btn-biga">Biga 100%</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label>ğŸ“… ××¡×œ×•×œ:</label>
            <select id="scheduleMode" class="timeline-select" onchange="calc()">
                <option value="1day" id="opt_sched_1">ğŸš€ ×™×•× ××—×“</option>
                <option value="2day" id="opt_sched_2">ğŸŒ™ ×™×•××™×™×</option>
                <option value="3day" id="opt_sched_3" selected>â„ï¸ 3 ×™××™×</option>
            </select>
        </div>
        <div>
            <label>ğŸ’¼ ×–××™× ×•×ª:</label>
            <select id="workMode" class="work-constraint" onchange="calc()">
                <option value="flexible">ğŸ  ×’××™×©</option>
                <option value="work" selected>ğŸ’¼ ×¢×‘×•×“×” (17:00+)</option>
            </select>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>×›××•×ª ×›×“×•×¨×™×</label><input type="number" id="balls" value="6" oninput="calc()"></div>
        <div><label>××©×§×œ ×›×“×•×¨ (×’')</label><input type="number" id="weight" value="250" oninput="calc()"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>×”×™×“×¨×¦×™×” (%)</label><input type="number" id="hydration" value="67" oninput="calc()"></div>
        <div>
            <label>ğŸŒ¡ï¸ ×˜××¤' ×—×“×¨</label>
            <input type="number" id="roomTemp" class="temp-select" value="20" oninput="calc()">
            <div class="weather-btn" onclick="getWeather()">ğŸ“¡ ×§×‘×œ ×˜××¤' × ×•×›×—×™×ª</div>
        </div>
    </div>

    <label>ğŸ•’ ××ª×™ ××•×›×œ×™×?</label>
    <input type="datetime-local" id="targetTime" onchange="calc()">

    <div id="scheduleArea" style="margin-top:25px; background:#f1f8e9; padding:10px; border-radius:12px;"></div>
    <div id="recipeArea" style="margin-top:15px; background:#fafafa; padding:15px; border-radius:12px; border:1px solid #eee;"></div>

    <div style="text-align:center; margin-top:25px; font-size:0.85rem; color:#90a4ae; cursor:pointer; text-decoration:underline;" onclick="document.getElementById('adv').style.display='block'">×”×’×“×¨×•×ª ××ª×§×“××•×ª</div>
    <div id="adv" class="hidden-adv">
        <label>××œ×— (%)</label><input type="number" id="saltPct" value="2.5" step="0.1" oninput="calc()">
        <label>×©××¨×™× ×‘×¡×™×¡ (%)</label><input type="number" id="yeastPct" value="0.5" step="0.1" oninput="calc()">
        <label>×œ×ª×ª/Malt (%)</label><input type="number" id="maltPct" value="1.0" step="0.1" oninput="calc()">
        <label>×”×¨×›×‘ ×§××—×™×</label>
        <select id="flourMix" onchange="saveData()">
            <option value="red_nuvola">××™×§×¡ 50/50</option>
            <option value="nuvola">100% × ×•×‘×•×œ×”</option>
            <option value="red">100% ×§××¤×•×˜×• ××“×•×</option>
            <option value="red_shtibel">××™×§×¡ ×©×˜×™×‘×œ</option>
        </select>
    </div>
</div>

<div class="container">
    <h2>ğŸ¥ ×”×©×¨××•×ª ×•××ª×›×•× ×™×</h2>
    <div style="font-size:0.85rem; color:#f57f17; background:#fff3e0; padding:8px; border-radius:6px; margin-bottom:15px;">
        ğŸ’¡ ×©×™× ×œ×‘: ×”×¡×¨×˜×•× ×™× × ×©××¨×™× ×¨×§ ×¢×œ ×”××›×©×™×¨ ×”×–×”.
    </div>
    
    <div class="video-form">
        <input type="text" id="vidUrl" placeholder="×”×“×‘×§ ×œ×™× ×§ ××™×•×˜×™×•×‘..." style="margin-top:0;">
        <input type="text" id="vidTitle" placeholder="×›×•×ª×¨×ª ×”×¡×¨×˜×•×Ÿ...">
        <select id="vidTag" style="margin-bottom:10px;">
            <option value="batzek">ğŸ ×‘×¦×§ ×•×˜×›× ×™×§×”</option>
            <option value="topping">ğŸ… ×ª×•×¡×¤×•×ª ×•×¨×•×˜×‘</option>
            <option value="general">ğŸ• ×›×œ×œ×™</option>
        </select>
        <button onclick="addVideo()" class="btn-main" style="width:100%; background:#546e7a;">×©××•×¨ ×¡×¨×˜×•×Ÿ +</button>
    </div>

    <div class="filter-bar">
        <div class="filter-chip active" onclick="filterVids('all', this)">×”×›×œ</div>
        <div class="filter-chip" onclick="filterVids('batzek', this)">×‘×¦×§</div>
        <div class="filter-chip" onclick="filterVids('topping', this)">×ª×•×¡×¤×•×ª</div>
        <div class="filter-chip" onclick="filterVids('general', this)">×›×œ×œ×™</div>
    </div>

    <div id="videoList" class="video-grid"></div>
</div>

<div class="container">
    <h2>ğŸ›’ ×ª×¤×¨×™×˜ ×•×§× ×™×•×ª</h2>
    <div class="status-bar">
        <span>× ×‘×—×¨×•: <strong id="totalSelected">0</strong></span>
        <span id="matchStatus"></span>
    </div>
    
    <div id="menuList" class="menu-grid"></div>

    <div class="action-grid">
        <button onclick="generateShopping()" class="btn-main" style="background:var(--accent);">ğŸ›’ ×”×¦×’ ×¨×©×™××”</button>
        <button onclick="shareWhatsApp()" class="btn-main" style="background:#25D366;">ğŸ’¬ ×©×œ×— ×‘×•×•××˜×¡××¤</button>
    </div>

    <div id="shoppingResult" style="display:none; margin-top:20px;">
        <div class="prep-guide" style="background:#fff8e1; padding:15px; border-radius:10px; border:1px solid #ffe082;">
            <h3 style="margin:0 0 10px 0; color:#f57f17;">ğŸ”ª ×”×›× ×•×ª</h3>
            <div id="prepList"></div>
        </div>
        <div class="shopping-list" style="margin-top:15px;">
            <h3 style="margin:0 0 10px 0; color:#37474f;">ğŸ“‹ ××¦×¨×›×™×</h3>
            <div id="shopList"></div>
        </div>
    </div>
    
    <div onclick="resetApp()" class="reset-link">ğŸ”„ ××™×¤×•×¡ × ×ª×•× ×™× ×•××—×™×§×ª ×”×›×œ</div>
</div>

<div class="fab-btn" onclick="document.getElementById('sosModal').style.display='flex'">ğŸ†˜</div>
<div class="modal-overlay" id="sosModal">
    <div class="modal-content">
        <div class="modal-header"><h2>ğŸ†˜ ×©××œ×•×ª × ×¤×•×¦×•×ª</h2><span class="close-btn" onclick="document.getElementById('sosModal').style.display='none'">&times;</span></div>
        <div id="qaList"></div>
    </div>
</div>

<script>
    // --- STATE ---
    let currentMethod = 'biga';
    let menuCounts = {};
    let savedVideos = [];
    let checkedSteps = {}; 

    // --- INIT ---
    function init() {
        initMenu();
        loadData();
        renderVideos();
        
        const qa = [
            {q:"×”×‘×¦×§ ×“×‘×™×§ ×‘×˜×™×¨×•×£", a:"×ª×Ÿ ×× ×•×—×” ×©×œ 10 ×“×§' ××›×•×¡×” ×•×—×–×•×¨ ×œ×œ×•×©. ××œ ×ª×•×¡×™×£ ×§××—!"},
            {q:"×”×‘×™×’×” ×™×‘×©×” ××“×™", a:"×–×” ×ª×§×™×Ÿ! ×–×” ×××•×¨ ×œ×”×™×•×ª ×¤×™×¨×•×¨×™× ×•×œ× ×‘×¦×§."},
            {q:"×”×‘×¦×§ × ×§×¨×¢ ×‘×¤×ª×™×—×”", a:"×”×’×œ×•×˜×Ÿ ××ª×•×—. ×—×›×” 30 ×“×§' ×‘×˜××¤' ×”×—×“×¨."}
        ];
        document.getElementById('qaList').innerHTML = qa.map(x => `<div class="qa-item" onclick="this.lastElementChild.style.display=this.lastElementChild.style.display=='block'?'none':'block'"><div class="qa-question">${x.q} â–¼</div><div class="qa-answer" style="display:none; margin-top:5px; color:#555;">${x.a}</div></div>`).join('');

        if(!document.getElementById('targetTime').value) {
            const t = new Date(); t.setDate(t.getDate()+2); t.setHours(20,0,0,0);
            const pad = n => n<10 ? '0'+n : n;
            document.getElementById('targetTime').value = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}T${pad(t.getHours())}:${pad(t.getMinutes())}`;
        }
        
        calc();
    }

    // --- LOGIC: WEATHER ---
    function getWeather() {
        if (!navigator.geolocation) return alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×§×•×");
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                const data = await res.json();
                document.getElementById('roomTemp').value = Math.round(data.current_weather.temperature);
                calc();
                alert(`×”×˜××¤×¨×˜×•×¨×” ×¢×•×“×›× ×”: ${data.current_weather.temperature}Â°C`);
            } catch(e) { alert("×©×’×™××” ×‘×§×‘×œ×ª ××–×’ ××•×•×™×¨"); }
        }, () => alert("×™×© ×œ××©×¨ ×’×™×©×” ×œ××™×§×•×"));
    }

    // --- LOGIC: CALCULATOR ---
    function calc() {
        const p = {
            balls: +document.getElementById('balls').value,
            weight: +document.getElementById('weight').value,
            hyd: +document.getElementById('hydration').value,
            temp: +document.getElementById('roomTemp').value,
            salt: +document.getElementById('saltPct').value,
            yeast: +document.getElementById('yeastPct').value,
            malt: +document.getElementById('maltPct').value,
            mode: document.getElementById('scheduleMode').value,
            work: document.getElementById('workMode').value,
            date: new Date(document.getElementById('targetTime').value)
        };

        // Temp Adjustment
        let tempFactor = 1.0;
        let waterTip = "";
        if (p.temp > 24) {
            tempFactor = p.temp >= 30 ? 0.6 : 0.8;
            waterTip = "××™× ×§×¨×™× ×××•×“ (×§×¨×—)";
        } else if (p.temp < 20) {
            tempFactor = p.temp <= 15 ? 1.4 : 1.2;
            waterTip = "××™× ×¤×•×©×¨×™× (25Â°C)";
        } else {
            waterTip = "××™× ×‘×˜××¤' ×”×—×“×¨";
        }
        
        let yPct = p.yeast * tempFactor;
        if (p.mode === '1day' && currentMethod === 'direct') yPct = 0.3 * tempFactor;
        if (p.mode === '3day') yPct = 0.5 * tempFactor;

        // Weights
        const total = p.balls * p.weight;
        const totalPct = 100 + p.hyd + p.salt + yPct + p.malt;
        const flour = Math.round((total / totalPct) * 100);
        const water = Math.round(flour * (p.hyd/100));
        const salt = Math.round(flour * (p.salt/100) * 10)/10;
        const yeast = Math.round(flour * (yPct/100) * 10)/10;
        const malt = Math.round(flour * (p.malt/100) * 10)/10;

        // Schedule
        const subH = (d,h) => new Date(d.getTime() - (h*3600000));
        let steps = [];
        let bake = p.date;
        steps.push({t: bake, txt: "ğŸ”¥ ×–××Ÿ ××¤×™×™×”", id: "bake"});

        let mix, ball;
        
        if (p.mode === '3day') {
            let rest = 3; 
            let pull = subH(bake, rest);
            ball = subH(pull, 24);
            mix = subH(ball, 1);
            if (p.work === 'work' && mix.getHours() < 17 && mix.getHours() > 6) {
                mix.setHours(17,0);
                ball = new Date(mix.getTime() + 3600000);
            }
            steps.push({t: pull, txt: "ğŸŒ¡ï¸ ×”×•×¦××” ××”××§×¨×¨", id: "pull"});
            steps.push({t: ball, txt: "ğŸ”´ ×›×“×¨×•×¨ ×œ××§×¨×¨", id: "ball"});
            steps.push({t: mix, txt: "ğŸ—ï¸ ×”×›× ×ª ×‘×¦×§ ×¢×™×§×¨×™", id: "mix"});
            if(currentMethod !== 'direct') steps.push({t: subH(mix, 18), txt: "ğŸ¥£ ×”×›× ×ª ××§×“×™× (×‘×™×’×”/×¤×•×œ×™×©)", id: "pref"});
        } else if (p.mode === '2day') {
            ball = subH(bake, 5);
            mix = subH(ball, 1);
            if (p.work === 'work' && mix.getHours() < 17 && mix.getHours() > 6) {
                mix.setHours(17,0); ball = new Date(mix.getTime() + 3600000);
            }
            steps.push({t: ball, txt: "ğŸ”´ ×›×“×¨×•×¨ ×•×”×ª×¤×—×”", id: "ball"});
            steps.push({t: mix, txt: "ğŸ—ï¸ ×”×›× ×ª ×‘×¦×§ ×¢×™×§×¨×™", id: "mix"});
            if(currentMethod !== 'direct') steps.push({t: subH(mix, 18), txt: "ğŸ¥£ ×”×›× ×ª ××§×“×™×", id: "pref"});
        } else {
            ball = subH(bake, 4);
            mix = subH(ball, 1);
            steps.push({t: ball, txt: "ğŸ”´ ×›×“×¨×•×¨", id: "ball"});
            steps.push({t: mix, txt: "ğŸ—ï¸ ×œ×™×©×”", id: "mix"});
        }

        steps.sort((a,b) => a.t - b.t);

        const days = ['×\'','×‘\'','×’\'','×“\'','×”\'','×•\'','×©\''];
        const fmt = d => `<span class="day-badge">${days[d.getDay()]}</span> ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        
        let schedHtml = `<h3 style="margin:0 0 10px 0;">ğŸ“… ×œ×•"×– (×œ×—×¥ ×œ×¡×™××•×Ÿ)</h3>`;
        steps.forEach(s => {
            const isChecked = checkedSteps[s.id] ? 'checked' : '';
            schedHtml += `<div class="checklist-item ${isChecked}" onclick="toggleStep('${s.id}')">
                <div class="step-txt">${s.txt}</div>
                <div class="meta-group">${fmt(s.t)} <span class="check-icon">${isChecked ? 'âœ…' : 'â¬œ'}</span></div>
            </div>`;
        });
        document.getElementById('scheduleArea').innerHTML = schedHtml;

        let rHtml = `<h3 style="margin:0 0 10px 0;">ğŸ• ××ª×›×•×Ÿ (${currentMethod === 'biga' ? 'Biga 100%' : currentMethod})</h3>`;
        
        if (currentMethod === 'biga') {
            let pFlour = Math.round(flour); 
            let pWater = Math.round(flour * 0.45);
            let mainWater = water - pWater;
            rHtml += row("×§××— (×œ×‘×™×’×”)", pFlour);
            rHtml += row("××™× (×œ×‘×™×’×”)", pWater);
            rHtml += row("×©××¨×™×", yeast);
            rHtml += `<hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">`;
            rHtml += row(`××™× × ×•×¡×¤×™× <br><span style="font-size:0.8rem;color:#1565c0">${waterTip}</span>`, mainWater);
            rHtml += row("××œ×—", salt);
            rHtml += row("×œ×ª×ª (Malt)", malt);
        } else if (currentMethod === 'poolish') {
            let pFlour = Math.round(flour * 0.3);
            let pWater = pFlour;
            let mainFlour = flour - pFlour;
            let mainWater = water - pWater;
            let pYeast = 0.2; 
            rHtml += row("×§××— (×œ×¤×•×œ×™×©)", pFlour);
            rHtml += row("××™× (×œ×¤×•×œ×™×©)", pWater);
            rHtml += row("×©××¨×™× (×œ×¤×•×œ×™×©)", pYeast);
            rHtml += `<hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">`;
            rHtml += row("×§××— × ×•×¡×£", mainFlour);
            rHtml += row(`××™× × ×•×¡×¤×™× <br><span style="font-size:0.8rem;color:#1565c0">${waterTip}</span>`, mainWater);
            rHtml += row("×©××¨×™× × ×•×¡×¤×™×", (yeast - pYeast).toFixed(1));
            rHtml += row("××œ×—", salt);
        } else {
            rHtml += row("×§××—", flour);
            rHtml += row(`××™× <br><span style="font-size:0.8rem;color:#1565c0">${waterTip}</span>`, water);
            rHtml += row("×©××¨×™×", yeast);
            rHtml += row("××œ×—", salt);
        }
        
        document.getElementById('recipeArea').innerHTML = rHtml;
        saveData();
        updateMenuStatus();
    }

    function row(lbl, val) { return `<div class="row"><span class="row-label">${lbl}</span><span class="row-value">${val} ×’×¨×</span></div>`; }

    function toggleStep(id) {
        checkedSteps[id] = !checkedSteps[id];
        calc(); 
    }

    // --- LOGIC: VIDEOS ---
    function addVideo() {
        const url = document.getElementById('vidUrl').value;
        const title = document.getElementById('vidTitle').value;
        const tag = document.getElementById('vidTag').value;
        
        if(!url) return;
        
        let vidId = "";
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length === 11) vidId = match[2];
        else return alert("×œ×™× ×§ ×œ× ×ª×§×™×Ÿ");

        savedVideos.push({ id: vidId, title: title || "×¡×¨×˜×•×Ÿ ×œ×œ× ×©×", tag: tag, added: new Date() });
        document.getElementById('vidUrl').value = "";
        document.getElementById('vidTitle').value = "";
        saveData();
        renderVideos();
    }

    function renderVideos(filter = 'all') {
        const list = document.getElementById('videoList');
        list.innerHTML = "";
        
        const filtered = filter === 'all' ? savedVideos : savedVideos.filter(v => v.tag === filter);
        
        if (filtered.length === 0) list.innerHTML = `<div style="text-align:center; color:#999; margin-top:10px;">××™×Ÿ ×¡×¨×˜×•× ×™× ×‘×§×˜×’×•×¨×™×” ×–×•</div>`;

        filtered.forEach((v, idx) => {
            const tagNames = { batzek: "×‘×¦×§", topping: "×ª×•×¡×¤×•×ª", general: "×›×œ×œ×™" };
            const realIdx = savedVideos.indexOf(v);
            list.innerHTML += `
                <div class="video-card">
                    <a href="https://www.youtube.com/watch?v=${v.id}" target="_blank">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg" class="video-thumb">
                    </a>
                    <div class="video-content">
                        <a href="https://www.youtube.com/watch?v=${v.id}" target="_blank" class="video-title">${v.title}</a>
                        <div class="video-footer">
                            <span class="video-tag">${tagNames[v.tag]}</span>
                            <span class="delete-vid" onclick="deleteVideo(${realIdx})">ğŸ—‘ï¸</span>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function deleteVideo(idx) {
        if(confirm("×œ××—×•×§ ×¡×¨×˜×•×Ÿ?")) {
            savedVideos.splice(idx, 1);
            saveData();
            renderVideos();
        }
    }

    function filterVids(tag, el) {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        renderVideos(tag);
    }

    // --- LOGIC: MENU & SHARING ---
    const pizzaMenu = [
        { id: 'marinara', name: '××¨×™× ×¨×”', icon: 'ğŸ…', ing: { sauce: 90, garlic: 1, oregano: 1 } },
        { id: 'margherita', name: '××¨×’×¨×™×˜×”', icon: 'ğŸ§€', ing: { sauce: 90, mozzarella: 100, basil: 5, parmesan: 5 } },
        { id: 'zucchini', name: '×–×•×§×™× ×™', icon: 'ğŸ¥’', ing: { zucchini: 0.5, rosemary: 1, mozzarella: 50 } },
        { id: 'pepperoni', name: '×¤×¤×¨×•× ×™', icon: 'ğŸ¥“', ing: { sauce: 90, mozzarella: 100, pepperoni: 40 } },
        { id: 'potato', name: '×ª×¤"×', icon: 'ğŸ¥”', ing: { potato: 1, parmesan: 15, guanciale: 40, mozzarella: 50 } },
        { id: 'garlic', name: '×©×•× ×—×¨×™×£', icon: 'ğŸŒ¶ï¸', ing: { garlic: 2, chili: 0.5 } }
    ];

    function initMenu() {
        const list = document.getElementById('menuList');
        list.innerHTML = pizzaMenu.map(p => `
            <div class="menu-item">
                <span class="menu-name">${p.icon} ${p.name}</span>
                <div class="menu-controls">
                    <button class="qty-btn" onclick="changeQty('${p.id}', -1)">-</button>
                    <span class="qty-val" id="count-${p.id}">0</span>
                    <button class="qty-btn" onclick="changeQty('${p.id}', 1)">+</button>
                </div>
            </div>`).join('');
    }

    function changeQty(id, d) {
        if (!menuCounts[id]) menuCounts[id] = 0;
        if (menuCounts[id] + d >= 0) {
            menuCounts[id] += d;
            document.getElementById(`count-${id}`).innerText = menuCounts[id];
            saveData();
            updateMenuStatus();
        }
    }

    function updateMenuStatus() {
        const total = Object.values(menuCounts).reduce((a,b)=>a+b, 0);
        document.getElementById('totalSelected').innerText = total;
        const balls = +document.getElementById('balls').value;
        const el = document.getElementById('matchStatus');
        if(total === balls) { el.innerText = "âœ… ×‘×•×œ!"; el.style.color="#81c784"; }
        else if(total > balls) { el.innerText = `âŒ ×—×¨×™×’×” (${total-balls})`; el.style.color="#ef5350"; }
        else { el.innerText = `âš ï¸ × ×•×ª×¨ (${balls-total})`; el.style.color="#ffb74d"; }
    }

    function generateShopping() {
        let totalIng = {};
        const dict = { sauce: "×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª", mozzarella: "××•×¦×¨×œ×”", garlic: "×©×•×", oregano: "××•×¨×’× ×•", basil: "×‘×–×™×œ×™×§×•×", parmesan: "×¤×¨××–'×Ÿ", zucchini: "×–×•×§×™× ×™", rosemary: "×¨×•×–××¨×™×Ÿ", pepperoni: "×¤×¤×¨×•× ×™", potato: "×ª×¤×•×— ××“××”", guanciale: "×’×•×•×× ×¦'×œ×”", chili: "×¦'×™×œ×™" };
        
        pizzaMenu.forEach(p => {
            const c = menuCounts[p.id] || 0;
            if (c > 0) {
                for (const [k, v] of Object.entries(p.ing)) {
                    totalIng[k] = (totalIng[k] || 0) + (v * c);
                }
            }
        });

        let html = "";
        for (const [k, v] of Object.entries(totalIng)) {
            html += `<div class="checklist-item"><div class="shop-text" style="flex-grow:1">${dict[k] || k}</div><div style="font-weight:bold;">${v}</div><div class="check-icon">â¬œ</div></div>`;
        }
        document.getElementById('shopList').innerHTML = html || "×œ× × ×‘×—×¨×• ×¤×™×¦×•×ª";
        document.getElementById('shoppingResult').style.display = 'block';
        document.getElementById('shoppingResult').scrollIntoView({behavior:'smooth'});
        
        let prepHtml = "";
        if(totalIng.potato) prepHtml += `<div class="checklist-item"><div class="step-txt">ğŸ¥” ×œ×¤×¨×•×¡ ×ª×¤"× ×“×§ ×•×œ×”×©×¨×•×ª ×‘××™×</div></div>`;
        if(totalIng.zucchini) prepHtml += `<div class="checklist-item"><div class="step-txt">ğŸ¥’ ×œ×¤×¨×•×¡ ×–×•×§×™× ×™ ×•×œ×”××œ×™×— (×”×’×¨×ª × ×•×–×œ×™×)</div></div>`;
        if(totalIng.sauce) prepHtml += `<div class="checklist-item"><div class="step-txt">ğŸ… ×œ×”×›×™×Ÿ ×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª</div></div>`;
        
        document.getElementById('prepList').innerHTML = prepHtml || "××™×Ÿ ×”×›× ×•×ª ××™×•×—×“×•×ª";
    }

    function shareWhatsApp() {
        let txt = "*×¨×©×™××ª ×§× ×™×•×ª ×œ×¤×™×¦×” (Pizza Ops)* ğŸ•\n\n";
        
        let totalIng = {};
        const dict = { sauce: "×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª", mozzarella: "××•×¦×¨×œ×”", garlic: "×©×•×", oregano: "××•×¨×’× ×•", basil: "×‘×–×™×œ×™×§×•×", parmesan: "×¤×¨××–'×Ÿ", zucchini: "×–×•×§×™× ×™", rosemary: "×¨×•×–××¨×™×Ÿ", pepperoni: "×¤×¤×¨×•× ×™", potato: "×ª×¤×•×— ××“××”", guanciale: "×’×•×•×× ×¦'×œ×”", chili: "×¦'×™×œ×™" };
        pizzaMenu.forEach(p => {
            const c = menuCounts[p.id] || 0;
            if (c > 0) for (const [k, v] of Object.entries(p.ing)) totalIng[k] = (totalIng[k] || 0) + (v * c);
        });

        if (Object.keys(totalIng).length === 0) return alert("×‘×—×¨ ×¤×™×¦×•×ª ×§×•×“×!");

        for (const [k, v] of Object.entries(totalIng)) {
            txt += `âœ… ${dict[k] || k}: ${v}\n`;
        }
        
        const balls = document.getElementById('balls').value;
        txt += `\n*×‘×¦×§ (${balls} ×›×“×•×¨×™×):*\n`;
        txt += `ğŸŒ¾ ×œ×‘×“×•×§ ×©×™×© ×§××— ×•×©××¨×™× ×‘×‘×™×ª!`;

        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
    }

    // --- DATA ---
    function saveData() {
        const d = {
            inputs: {
                balls: document.getElementById('balls').value,
                weight: document.getElementById('weight').value,
                hyd: document.getElementById('hydration').value,
                temp: document.getElementById('roomTemp').value,
                date: document.getElementById('targetTime').value,
                salt: document.getElementById('saltPct').value,
                yeast: document.getElementById('yeastPct').value,
                malt: document.getElementById('maltPct').value,
                sched: document.getElementById('scheduleMode').value,
                work: document.getElementById('workMode').value,
                flour: document.getElementById('flourMix').value
            },
            method: currentMethod,
            counts: menuCounts,
            videos: savedVideos,
            checks: checkedSteps
        };
        localStorage.setItem('pizzaOpsV6', JSON.stringify(d));
    }

    function loadData() {
        const d = JSON.parse(localStorage.getItem('pizzaOpsV6'));
        if (d) {
            if(d.inputs) {
                for(let k in d.inputs) {
                    const el = document.getElementById({balls:'balls', weight:'weight', hyd:'hydration', temp:'roomTemp', date:'targetTime', salt:'saltPct', yeast:'yeastPct', malt:'maltPct', sched:'scheduleMode', work:'workMode', flour:'flourMix'}[k]);
                    if(el) el.value = d.inputs[k];
                }
            }
            if(d.method) setMethod(d.method);
            if(d.counts) menuCounts = d.counts;
            if(d.videos) savedVideos = d.videos;
            if(d.checks) checkedSteps = d.checks;
            
            // UI Update
            for (const [id, c] of Object.entries(menuCounts)) {
                const el = document.getElementById(`count-${id}`);
                if(el) el.innerText = c;
            }
        }
    }

    function setMethod(m) {
        currentMethod = m;
        document.querySelectorAll('.method-opt').forEach(e => e.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
        calc();
    }

    function resetApp() {
        if(confirm("×‘×˜×•×— ×©×¨×•×¦×™× ×œ××¤×¡ ×”×›×œ?")) {
            localStorage.removeItem('pizzaOpsV6');
            location.reload();
        }
    }

    init();
</script>
</body>
</html>
